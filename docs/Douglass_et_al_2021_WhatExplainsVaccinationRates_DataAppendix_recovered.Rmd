---
title: "What explains U.S. Covid-19 Vaccination Rates? Data Appendix"
author: "Rex W. Douglass"
output:  html_notebook
bibliography: WhatExplainsUSCovid19VaccinationRates.bib
---

# Libray Loads

```{r}

fromscratch=F

knitr::opts_chunk$set(fig.width = 8, fig.height = 8, message=F, warning=F, echo=F, results=F)

#Library Loads
library(pacman)
p_load(tidyverse)
p_load(janitor)
p_load(tidylog)
p_load(stringr)
p_load(ggdag)
p_load(data.table)
p_load(sf)
p_load(glue)
p_load(scales)
options(tigris_use_cache = TRUE)


restartspark <- function(){
  #devtools::install_github("rstudio/sparklyr")
  #devtools::install_github("rstudio/sparklyr")
  #install.packages('sparklyr') #rolling back to the stable version
  library(sparklyr)
  #spark_available_versions()
  #spark_installed_versions()
  #spark_uninstall(version="3.0.1", hadoop_version="3.2")
  #spark_uninstall(version="2.4.3", hadoop_version="2.7")
  #oh interesting the default is spark 2.4.3 I wonder why that is
  #Error: Java 11 is only supported for Spark 3.0.0+
  #spark_install("3.0") #3.1.1 is currently the latest stable, but 3.0 is the latest available

  #library(geospark)
  #library(arrow)
  mem="160G"
  try({spark_disconnect(sc)})
  conf <- spark_config()
  #conf$`sparklyr.cores.local` <- 128
  #https://datasystemslab.github.io/GeoSpark/api/sql/GeoSparkSQL-Parameter/
  conf$spark.serializer <- "org.apache.spark.serializer.KryoSerializer"
  #conf$spark.kryo.registrator <- "org.datasyslab.geospark.serde.GeoSparkKryoRegistrator"
  #conf$spark.kryoserializer.buffer.max <- "2047MB" #Caused by: java.lang.IllegalArgumentException: spark.kryoserializer.buffer.max must be less than 2048 mb, got: + 10240 mb.
  #https://github.com/DataSystemsLab/GeoSpark/issues/217
  #conf$geospark.global.index <- "true"
  #conf$geospark.global.indextype <- "quadtree"
  #conf$geospark.join.gridtype <- "kdbtree"
  #conf$spark.sql.shuffle.partitions <- 1999 #https://github.com/DataSystemsLab/GeoSpark/issues/361 #setting to just under 2k so compression doesn't kick in, don't need to lower the memory footprint
  conf$spark.driver.maxResultSize <- "100G"
  conf$spark.memory.fraction <- 0.9
  conf$spark.storage.blockManagerSlaveTimeoutMs <-"6000000s" #Failed during initialize_connection: java.lang.IllegalArgumentException: requirement failed: spark.executor.heartbeatInterval should be less than or equal to spark.storage.blockManagerSlaveTimeoutMs
  conf$spark.executor.heartbeatInterval <-"6000000s"# "10000000s"
  conf$spark.network.timeout <- "6000001s"
  conf$spark.local.dir <- "/mnt/8tb_b/spark_temp/"
  conf$spark.worker.cleanup.enabled <- "true"
  conf$"sparklyr.shell.driver-memory"= mem
  conf$'spark.driver.maxResultSize' <- 0 #0 is ulimmited
  
  conf$'spark.sql.legacy.parquet.datetimeRebaseModeInRead' <- 'LEGACY'
  conf$'spark.sql.legacy.parquet.datetimeRebaseModeInWrite' <- 'LEGACY'
  
  conf$'spark.sql.execution.arrow.maxRecordsPerBatch' <- "5000000" #https://github.com/arctern-io/arctern/issues/399
  
  #Error: org.apache.spark.sql.AnalysisException: The pivot column variable_clean has more than 10000 distinct values, this could indicate an error. If this was intended, set spark.sql.pivotMaxValues to at least the number of distinct values of the pivot column.;
  conf$'spark.sql.pivotMaxValues' <- "5000000"
  
  sc <<- spark_connect(master = "local", config = conf#,
                      #version = "2.3.3" #for geospark
  ) 
}

restartspark()


rex_clean <- function(x){
  if(!"variable_short" %in% colnames(x)) {x$variable_short <- NA}
  if(!"variable_short_group" %in% colnames(x)) {x$variable_short_group <- NA}
  
   x %>% 
     mutate(fips=as.numeric(fips)) %>% 
     filter(!is.na(fips)) %>% 
     dplyr::select(fips, dataset, variable_short_group, variable_short, variable,  description, value) %>%
     mutate_at(vars(dataset, variable_short_group, variable_short, variable,  description), as.character) %>%
     mutate(value=as.numeric(value)) %>%
     filter(!is.na(value))

}

```

# Appendix 1 Unit of Analysis Train Test Split

```{r}

p_load(tidyverse)
p_load(urbnmapr)
p_load(tigris)
#library(leaflet)
counties_sf_tigris <- tigris::counties(state = NULL, cb = FALSE, resolution = "5m", year = 2019) %>% mutate(fips=paste0(STATEFP, COUNTYFP) %>% as.numeric) %>% arrange(fips)
states_sf_tigris <- tigris::states(cb = TRUE)

if(fromscratch){
  counties_sf_tigris %>% fips()
  counties_sf_tigris$COUNTYFP %>% table()
  p_load(nngeo)
  dyad_list <- list()
  for(i in counties_sf_tigris$COUNTYFP %>% unique() %>% sort() ){
    print(i)
    temp <- st_join(counties_sf_tigris %>% filter(COUNTYFP==i) %>% dplyr::select(fips)  ,
                    counties_sf_tigris %>% dplyr::select(fips) ,
                    st_nn, k=10, maxdist = 1000, parallel=120, progress = T) %>% #dist is meters so 10k is 10km , #the memory requirements of this are massive
                    filter(fips.x!=fips.y) %>%
                    as.data.frame() %>%
                    dplyr::select(-geometry) %>% 
                    janitor::clean_names()
    dim(temp)
    dyad_list[[i]]<- temp
  }
  dyad_df <- bind_rows(dyad_list)
  dim(dyad_df)
  saveRDS(dyad_df, "/mnt/8tb_a/rwd_github_private/NESSrdf/dyad_df.Rds" )

}
dyad_df <- readRDS( "/mnt/8tb_a/rwd_github_private/NESSrdf/dyad_df.Rds" )

places_we_exclude <- c('United States Virgin Islands','Commonwealth of the Northern Mariana Islands','Hawaii','Puerto Rico','Guam','American Samoa','Alaska')

fips_we_exclude <- states_sf_tigris %>% dplyr::filter(NAME %in% places_we_exclude) %>% pull(STATEFP) %>% as.numeric()


states_sf_tigris_continental <- states_sf_tigris %>% dplyr::filter(!NAME %in% places_we_exclude)

#states_sf <- get_urbn_map("states", sf = TRUE) #they place alaska in as if its next to texas

centroids <- states_sf_tigris_continental %>% st_centroid() 
centroids <- cbind(centroids , data.frame(st_coordinates(centroids)) )


library(sperrorest); #install.packages('sperrorest')
  
coords_df <- data.frame(st_coordinates(centroids))
resamp <- partition_kmeans(coords_df, nfold = 3, coords = c("X", "Y"), repetition = 1:1, return_factor=T, balancing_steps=100)
table(resamp$`1`)
#plot(resamp, ecuador)
#folds = partition_tiles(coords_df, coords = c("X", "Y"), nsplit=c(2,2) ) #, min_n=0.8

states_sf_tigris_continental$fold_kmeans = resamp$`1`
#states_sf_tigris_continental <- states_sf_tigris_continental %>% 
#             mutate(fold = recode(as.character(fold), '1'=2,'5'=2, '2'=2, '3'=3, '3'=3, '4'=4)) %>% 
#             mutate(fold = recode(as.character(fold), '2'=1,'3'=2, '4'=3)) #relevel them


#table(states_sf_tigris_continental$fold)

#State Flows
fnames <- list.files("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_temp/COVID19USFlows/weekly_flows/state2state/", pattern = "csv", full.names = T)
flows_state2state <- rbindlist(lapply(fnames, fread), fill=T)
flows_state2state_clean <- flows_state2state %>%
                                filter(!geoid_o %in% fips_we_exclude,
                                       !geoid_d %in% fips_we_exclude) %>%
                            filter(geoid_o!=geoid_d) %>%
                            separate(date_range, c("start1", "start2"), sep = " - ", remove=F) %>%
                            filter(start1 %>% str_detect("/19$")) %>%
                            #mutate(start1= lubridate::as_date(start1) ) %>% 
                            #mutate(start2= lubridate::as_date(start2) ) %>% 
                            #filter(start1 < lubridate::as_date("2020-01-01") ) %>%
                            #filter(start2 < lubridate::as_date("2020-01-01") ) %>%

                            group_by(geoid_o,geoid_d) %>% 
                            summarise(pop_flows_log=sum(pop_flows) %>% log() )

#hist(flows_state2state_clean$pop_flows_log ) #state to state flows are log normal so we're good

flows_state2state_clean_wide <- flows_state2state_clean %>% 
                                mutate(geoid_o=str_pad(geoid_o, 2, pad = "0")) %>%
                                mutate(geoid_d=str_pad(geoid_d, 2, pad = "0")) %>%
                                pivot_wider(names_from = geoid_d, values_from = pop_flows_log, values_fill = NA) %>% 
                                ungroup() %>%
                                dplyr::select(-geoid_o)   %>% 
                                select(sort(current_vars()))
dim(flows_state2state_clean_wide) #Ok this is now a 49x49 state matrix corrcetly sorted in order with leading zeros

flows_state2state_clean_wide_inverse <- 1/flows_state2state_clean_wide
flows_state2state_clean_wide_inverse_d <- as.dist(flows_state2state_clean_wide_inverse)
hc <- hclust(flows_state2state_clean_wide_inverse_d, method = "ward.D2")
#plot(hc)
#table(cutree(hc, k=4)) #The north east is unbalanced, but possibly not in terms of counties?
#table(cutree(hc, k=6)) #The north east is unbalanced, but possibly not in terms of counties?

states_sf_tigris_continental <- states_sf_tigris_continental %>% arrange(STATEFP) %>% 
                                mutate(fold_4=cutree(hc, k=4)) %>%  
                                mutate(fold_5=cutree(hc, k=5)) %>%
                                mutate(fold_6=cutree(hc, k=6)) %>% #siz it is
                                mutate(fold_8=cutree(hc, k=8)) %>%
                                mutate(fold=fold_6 %>% as.factor())

saveRDS(states_sf_tigris_continental, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/states_sf_tigris_continental.Rds")

```



# Appendix 2 Demographics


### Census 2020 Actual Demographics

Download ftp files from here ftp.census.gov/programs-surveys/decennial/2020/data/01-Redistricting_File--PL_94-171/

```{r}

labels_df <- data.frame(
  stringsAsFactors = FALSE,
              name = c("pop","pop_hisp","pop_white",
                       "pop_black","pop_aian","pop_asian","pop_nhpi",
                       "pop_other","pop_two","vap","vap_hisp","vap_white",
                       "vap_black","vap_aian","vap_asian","vap_nhpi","vap_other",
                       "vap_two"),
       description = c("population",
                       "hispanic population","white population","black population",
                       "American Indian and Alaska Native population","asian population",
                       "Native Hawaiians and Pacific Islanders population",
                       "other population","population of two or more races",
                       "18 years or older population",
                       "18 years or older hispanic population","18 years or older white populatin",
                       "18 years or older black population",
                       "18 years or older American Indian and Alaska Native population",
                       "18 years or older population",
                       "18 years or older Native Hawaiians and Pacific Islanders population",
                       "18 years or older other population","18 years or older population of two or more races")
)

#devtools::install_github("CoryMcCartan/PL94171")
library(PL94171)
if(fromscratch){
  #Uncompress all of them here
  zip_files <- list.files(path = "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/2020_pl_94_171/01-Redistricting_File--PL_94-171/", pattern = "*.zip", all.files = FALSE,
               full.names = T, recursive = T, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
  #sapply(zip_files, unzip, exdir = "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/2020_pl_94_171/01-Redistricting_File--PL_94-171/", overwrite =F) #Just dump all the pl files to one directory
  pl_list=list()
  for(file in zip_files){
    print(file)
    if(is.null(pl_list[[file]])){
      try({
        pl_list[[file]] <- file %>% PL94171::read_pl() %>% PL94171:::pl_widen() %>% dplyr::filter(SUMLEV=="050") %>% pl_select_standard(clean_names=TRUE)
      })
    }
  }
  pl_df <- pl_list%>% bind_rows() #going to have it iterate over each zip file
  dim(pl_df)
  saveRDS(pl_df, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_temp/pl_df.Rds")
}

pl_df <- readRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_temp/pl_df.Rds")

pl_df_total <-   pl_df %>% janitor::clean_names() %>% separate(geoid, c("temp","fips"), sep="US") %>%
                  dplyr::select(-temp,-state,-county,-row_id,-summary_level,-vtd) %>%
                  pivot_longer(-fips) %>% 
                  left_join(labels_df)

#pl_df_percent <- pl_df_total %>% group_by(fips) %>% mutate(value=value/max(value)) %>%
#                     mutate(name=paste0(name, "_percent")) %>%
#                     mutate(description=paste0(description, " percent"))

rhs_census_2020 <- bind_rows(pl_df_total) %>% mutate(dataset="census_2020_actual") %>% rename(variable=name) #we do percent at the end

rhs_census_2020  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020_actual.parquet"))


```


### Census 2020 Estimated Demographics

The 2020 age data aren't out yet, and so my idea is to use the estimated age distribution and multiply it by the observed total population to get approximate counts by age.

```{r}

#https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/asrh/
CC_EST2020 <- fread("https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/asrh/CC-EST2020-ALLDATA.csv") %>% clean_names() %>% dplyr::filter(year==13)

CC_EST2020_long <- CC_EST2020 %>% pivot_longer(cols=c(-sumlev, -state, -county, -stname, -ctyname, -year, -agegrp))

library(clipr)
library(datapasta) ; #install.packages('datapasta')
 
CC_EST2020_labels <- data.frame(
  stringsAsFactors = FALSE,
                                    name = c("STATE",
                                             "COUNTY",
                                            "STNAME",
                                            "CTYNAME",
                                            "YEAR",
                                            "AGEGRP",
                                            "TOT_POP","TOT_MALE","TOT_FEMALE",
                                            "WA_MALE","WA_FEMALE","BA_MALE",
                                            "BA_FEMALE","IA_MALE","IA_FEMALE",
                                            "AA_MALE","AA_FEMALE","NA_MALE",
                                            "NA_FEMALE","TOM_MALE","TOM_FEMALE",
                                            "WAC_MALE","WAC_FEMALE","BAC_MALE",
                                            "BAC_FEMALE","IAC_MALE",
                                            "IAC_FEMALE","AAC_MALE","AAC_FEMALE",
                                            "NAC_MALE","NAC_FEMALE","NH_MALE",
                                            "NH_FEMALE","NHWA_MALE","NHWA_FEMALE",
                                            "NHBA_MALE","NHBA_FEMALE",
                                            "NHIA_MALE","NHIA_FEMALE","NHAA_MALE",
                                            "NHAA_FEMALE","NHNA_MALE",
                                            "NHNA_FEMALE","NHTOM_MALE","NHTOM_FEMALE",
                                            "NHWAC_MALE","NHWAC_FEMALE",
                                            "NHBAC_MALE","NHBAC_FEMALE","NHIAC_MALE",
                                            "NHIAC_FEMALE","NHAAC_MALE",
                                            "NHAAC_FEMALE","NHNAC_MALE",
                                            "NHNAC_FEMALE","H_MALE","H_FEMALE",
                                            "HWA_MALE","HWA_FEMALE","HBA_MALE",
                                            "HBA_FEMALE","HIA_MALE","HIA_FEMALE",
                                            "HAA_MALE","HAA_FEMALE","HNA_MALE",
                                            "HNA_FEMALE","HTOM_MALE",
                                            "HTOM_FEMALE","HWAC_MALE","HWAC_FEMALE",
                                            "HBAC_MALE","HBAC_FEMALE",
                                            "HIAC_MALE","HIAC_FEMALE","HAAC_MALE",
                                            "HAAC_FEMALE","HNAC_MALE","HNAC_FEMALE") %>%
                                             tolower(),
  
                            description = c("State FIPS code",
                                            "County FIPS code",
                                            "State Name",
                                            "County Name",
                                            "Year",
                                            "Age group",
                                            "Total population",
                                            "Total male population",
                                            "Total female population",
                                            "White alone male population",
                                            "White alone female population",
                                            "Black or African American alone male population",
                                            "Black or African American alone female population",
                                            "American Indian and Alaska Native alone male population",
                                            "American Indian and Alaska Native alone female population",
                                            "Asian alone male population",
                                            "Asian alone female population",
                                            "Native Hawaiian and Other Pacific Islander alone male population",
                                            "Native Hawaiian and Other Pacific Islander alone female population",
                                            "Two or More Races male population",
                                            "Two or More Races female population",
                                            "White alone or in combination male population",
                                            "White alone or in combination female population",
                                            "Black or African American alone or in combination male population",
                                            "Black or African American alone or in combination female population",
                                            "American Indian and Alaska Native alone or in combination male population",
                                            "American Indian and Alaska Native alone or in combination female population",
                                            "Asian alone or in combination male population",
                                            "Asian alone or in combination female population",
                                            "Native Hawaiian and Other Pacific Islander alone or in combination male population",
                                            "Native Hawaiian and Other Pacific Islander alone or in combination female population","Not Hispanic male population",
                                            "Not Hispanic female population",
                                            "Not Hispanic, White alone male population",
                                            "Not Hispanic, White alone female population",
                                            "Not Hispanic, Black or African American alone male population",
                                            "Not Hispanic, Black or African American alone female population",
                                            "Not Hispanic, American Indian and Alaska Native alone male population",
                                            "Not Hispanic, American Indian and Alaska Native alone female population",
                                            "Not Hispanic, Asian alone male population",
                                            "Not Hispanic, Asian alone female population",
                                            "Not Hispanic, Native Hawaiian and Other Pacific Islander alone male population",
                                            "Not Hispanic, Native Hawaiian and Other Pacific Islander alone female population",
                                            "Not Hispanic, Two or More Races male population",
                                            "Not Hispanic, Two or More Races female population",
                                            "Not Hispanic, White alone or in combination male population",
                                            "Not Hispanic, White alone or in combination female population",
                                            "Not Hispanic, Black or African American alone or in combination male population",
                                            "Not Hispanic, Black or African American alone or in combination female population",
                                            "Not Hispanic, American Indian and Alaska Native alone or in combination male population",
                                            "Not Hispanic, American Indian and Alaska Native alone or in combination female population",
                                            "Not Hispanic, Asian alone or in combination male population",
                                            "Not Hispanic, Asian alone or in combination female population",
                                            "Not Hispanic, Native Hawaiian and Other Pacific Islander alone or in combination male population",
                                            "Not Hispanic, Native Hawaiian and Other Pacific Islander alone or in combination female population",
                                            "Hispanic male population",
                                            "Hispanic female population",
                                            "Hispanic, White alone male population",
                                            "Hispanic, White alone female population",
                                            "Hispanic, Black or African American alone male population",
                                            "Hispanic, Black or African American alone female population",
                                            "Hispanic, American Indian and Alaska Native alone male population",
                                            "Hispanic, American Indian and Alaska Native alone female population",
                                            "Hispanic, Asian alone male population",
                                            "Hispanic, Asian alone female population",
                                            "Hispanic, Native Hawaiian and Other Pacific Islander alone male population",
                                            "Hispanic, Native Hawaiian and Other Pacific Islander alone female population",
                                            "Hispanic, Two or More Races male population",
                                            "Hispanic, Two or More Races female population",
                                            "Hispanic, White alone or in combination male population",
                                            "Hispanic, White alone or in combination female population",
                                            "Hispanic, Black or African American alone or in combination male population",
                                            "Hispanic, Black or African American alone or in combination female population",
                                            "Hispanic, American Indian and Alaska Native alone or in combination male population",
                                            "Hispanic, American Indian and Alaska Native alone or in combination female population",
                                            "Hispanic, Asian alone or in combination male population",
                                            "Hispanic, Asian alone or in combination female population",
                                            "Hispanic, Native Hawaiian and Other Pacific Islander alone or in combination male population",
                                            "Hispanic, Native Hawaiian and Other Pacific Islander alone or in combination female population") %>% 
                                            tolower()
                     )

age_df <- data.frame(
  stringsAsFactors = FALSE,
                agegrp = c(0L,1L,2L,3L,4L,5L,6L,7L,
                       8L,9L,10L,11L,12L,13L,14L,15L,16L,17L,18L),
                agegrp_description = c("Total","Age 0 to 4 years",
                       "Age 5 to 9 years","Age 10 to 14 years",
                       "Age 15 to 19 years","Age 20 to 24 years","Age 25 to 29 years",
                       "Age 30 to 34 years","Age 35 to 39 years","Age 40 to 44 years",
                       "Age 45 to 49 years","Age 50 to 54 years",
                       "Age 55 to 59 years","Age 60 to 64 years","Age 65 to 69 years",
                       "Age 70 to 74 years","Age 75 to 79 years",
                       "Age 80 to 84 years","Age 85 years or older") %>% tolower()
)


CC_EST2020_long_clean <- CC_EST2020_long %>% 
                          left_join(CC_EST2020_labels)  %>% 
                          left_join(age_df) %>% 
                          mutate(age_group_start = agegrp_description %>% str_match(pattern="age (\\d+) to") %>% .[,2] %>% as.numeric()) %>%  
                          mutate(age_group_end = agegrp_description %>% str_match(pattern="to (\\d+) years") %>% .[,2] %>% as.numeric()) %>%
                          mutate(fips=paste0(state, county %>% str_pad(width=3, pad="0") )) %>% mutate(value=value %>% as.numeric())

agecuts <- CC_EST2020_long_clean$age_group_end %>% unique() %>% na.omit()
group_list <- list()
for(agecut in agecuts){
  df1 <- CC_EST2020_long_clean %>%
    filter(!is.na(age_group_start)) %>% 
    mutate(agecut=agecut) %>%
    mutate(agecut_above=(age_group_end>agecut) %>% as.integer()) %>% 
    mutate(agegroup=ifelse(agecut_above==0,paste0("at_or_below_",agecut," years old"), paste0("above_",agecut," years old")  ) ) %>%
    mutate(description = paste0("population_",agegroup, ",_",description) %>% tolower() ) %>%
    group_by(agecut_above, fips,  description ) %>% 
      summarize(value=sum(value)) 
  group_list[[as.character(agecut)]] <- df1
}


demographics_census2020_groups <-  
              bind_rows(group_list)  #%>% 
              #dplyr::select(fips, value, description) 

dim(demographics_census2020_groups) #66,307,871

CC_EST2020_long_clean2 <- CC_EST2020_long_clean %>% 
                          #mutate(census_2020_population_group = paste0("census_2020_population","_",agegrp_description, "_",description) %>% tolower() ) %>% 
                          #mutate(census_2020_population_group=census_2020_population_group %>% str_replace_all(pattern=" ",replacement="_")) %>%
                          mutate(description = paste0("population_",agegrp_description, ",_",description) %>% tolower()  ) # %>%  #%>% janitor::make_clean_names()
                          #dplyr::select(fips, value, description) 
  
rhs_census2020 <- bind_rows(CC_EST2020_long_clean2, 
                            demographics_census2020_groups) %>%
                            mutate(dataset="census2020") %>%
                            mutate(variable=paste0("census2020_",description)) %>%
                            dplyr::select(fips, variable, description, dataset, value)

rhs_census2020 %>% filter(fips==53025) %>% mutate(dupe=duplicated(variable)) %>% View()


rhs_census2020_perc <- rhs_census2020 %>% 
                       mutate(description= paste0("percent ",description)) %>% 
                       mutate(variable= paste0(variable,"_perc")) %>% 
                       group_by(fips) %>%
                        mutate(value= round( value/max(value),3)   ) %>% 
                       ungroup() %>%
                            dplyr::select(fips, variable, description, dataset, value)

rhs_census2020_perc %>% filter(fips==53025) %>% mutate(dupe=duplicated(variable)) %>% View()

rhs_census2020_perc  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020_perc.parquet"))

#rhs_census2020_perc_times_2020observed <- rhs_census2020 %>% 
#                                           group_by(fips) %>%
#                                            mutate(value= round( value/max(value),3)   ) %>% 
#                                           ungroup() %>% 
#                                           dplyr::select(fips, variable, description, dataset, value) %>%
#                                           mutate(fips=as.numeric(fips)) %>%
#                                           left_join(rhs_census_2020 %>% filter(variable=="pop") %>% dplyr::select(fips,pop_observed=value) %>% mutate(fips=as.numeric(fips)) ) %>%
#                                           mutate(value=value*pop_observed) %>%
#                                           dplyr::select(-pop_observed)
#
#rhs_census2020  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020.parquet"))


```


### Census 2019 Estimated Demographics

Skipping now that we have 2020 data above

```{r, eval=F}

p_load(tidycensus)
# Plot of race/ethnicity by county in Illinois for 2010
library(tidycensus)
library(tidyverse)
library(viridis)
if(fromscratch){
  census_api_key("5edb17356a7375fff24e36e53cc2749c78fb11af")
  census_2019_estimates <- get_estimates(geography = "county", 
                               year = 2019,
                               product = "characteristics", 
                               breakdown = c("SEX", "AGEGROUP", "HISP", 'RACE'),  
                               breakdown_labels = TRUE , 
                               #state = "CA", 
                               #county = "Los Angeles"
                               show_call=T
                               )
  saveRDS(census_2019_estimates, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/census_2019_estimates.Rds")
}
census_2019_estimates <- readRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/census_2019_estimates.Rds")

#We want to collapse age groups as well
census_2019_estimates_agegroups <- census_2019_estimates %>% 
                                   clean_names() %>% 
                                   mutate(age_group_start = agegroup %>% str_match(pattern="Age (\\d+) to") %>% .[,2] %>% as.numeric()) %>%  
                                   mutate(age_group_end = agegroup %>% str_match(pattern="to (\\d+) years") %>% .[,2] %>% as.numeric()) %>%
                                   filter(!is.na(age_group_start))

agecuts <- census_2019_estimates_agegroups$age_group_end %>% unique()
group_list <- list()
for(agecut in agecuts){
  df <- census_2019_estimates_agegroups %>% mutate(agecut=agecut) %>% mutate(agecut_above=(age_group_end>agecut) %>% as.integer()) %>% group_by(agecut_above, geoid, name, sex,hisp,race ) %>% summarise(value=sum(value)) %>%
    mutate(agegroup=ifelse(agecut_above==0,paste0("at_or_below_",agecut," years"), paste0("above_",agecut," years")  ) ) %>%  
    mutate(census_2019_population_group = paste0("census_2019_pop","_",sex, "_",agegroup,"_", hisp, "_", race) %>% tolower() ) %>% ungroup()
  group_list[[as.character(agecut)]] <- df
}

demographics_census_groups <-  bind_rows(group_list)  %>% dplyr::select(fips=geoid, value, census_2019_population_group)
dim(demographics_census_groups)

demographics_census <- census_2019_estimates %>%  
                          clean_names() %>%
                          mutate(census_2019_population_group = paste0("census_2019_pop","_",sex, "_",agegroup,"_", hisp, "_", race) %>% tolower() )  %>%
                          dplyr::select(fips=geoid, value, census_2019_population_group)
dim(demographics_census)

demographics_census_wide <- bind_rows(demographics_census_groups,demographics_census) %>% 
                            pivot_wider(id_cols=fips, names_from=census_2019_population_group, values_from=value) %>% #2092
                            clean_names()
dim(demographics_census_wide)

demographics_census_perc <-   demographics_census_wide %>%
                              mutate(across(-fips, ~ . /  census_2019_pop_both_sexes_all_ages_both_hispanic_origins_all_races)) %>% dplyr::select(-census_2019_pop_both_sexes_all_ages_both_hispanic_origins_all_races) %>%
                              rename_at(vars(-fips), paste0, "_perc")

rhs_demographics_census2019 <- cbind(
  demographics_census_wide#, demographics_census_perc
  )  %>% janitor::remove_empty() %>% janitor::remove_constant() %>% mutate_if(is.character, as.numeric)
dim(rhs_demographics_census2019) #3142 11311
saveRDS(rhs_demographics_census2019, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_demographics_census2019.Rds")




  
```

### ACS

"
When to Use 1-year, 3-year, or 5-year Estimates"
https://www.census.gov/programs-surveys/acs/guidance/estimates.html

```{r}


p_load(tidycensus)
vars_acs5 <- load_variables(2019, "acs5", cache = TRUE) #27,040

#What we're going to do is iterate over tables

tables_acs5 <- vars_acs5$name %>% str_split("_", simplify = T)
tables_acs5 <- tables_acs5[,1] %>% unique()
for(q in tables_acs5){
  
  outfile <- glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs5/{q}")
  #print(q)
  if(!file.exists(outfile)){
    try({
      temp_acs5_df <- get_acs(geography = "county", 
                    #variables = c(medincome = "B19013_001"), 
                    table= q,
                    #state = "VT", 
                    key="5edb17356a7375fff24e36e53cc2749c78fb11af",
                    year = 2019, 
                    cache_table=T,
                    survey="acs5"
                    )
      
      temp_acs5_df  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs5/{q}"))
    })
  }
}

temp_acs5_df_all <- arrow::open_dataset(sources="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs5/") %>% collect() %>% collect() %>% mutate(dataset="acs1")
dim(temp_acs5_df_all) #87,062,360

#The 3 year sample was discontinued in 2013
# vars_acs3 <- load_variables(2019, "acs3", cache = TRUE) #
# tables_acs3 <- vars_acs3$name %>% str_split("_", simplify = T)
# tables_acs3 <- tables_acs3[,1] %>% unique()
# for(q in tables_acs1){
#   
#   outfile <- glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs3/{q}")
#   #print(q)
#   if(!file.exists(outfile)){
#     try({
#       temp_acs1_df <- get_acs(geography = "county", 
#                     #variables = c(medincome = "B19013_001"), 
#                     table= q,
#                     #state = "VT", 
#                     key="5edb17356a7375fff24e36e53cc2749c78fb11af",
#                     year = 2019,
#                     cache_table=T,
#                     survey="acs3"
#                     )
#       
#       temp_acs3_df  %>% rex_clean() %>% arrow::write_parquet(outfile)
#     })
#   }
# }

#The 1 year estimate is available only for populations greater than 65k
vars_acs1 <- load_variables(2019, "acs1", cache = TRUE) #35,528 35k vars for 1 year
tables_acs1 <- vars_acs1$name %>% str_split("_", simplify = T)
tables_acs1 <- tables_acs1[,1] %>% unique()
for(q in tables_acs1){
  
  outfile <- glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs1/{q}")
  #print(q)
  if(!file.exists(outfile)){
    try({
      temp_acs1_df <- get_acs(geography = "county", 
                    #variables = c(medincome = "B19013_001"), 
                    table= q,
                    #state = "VT", 
                    key="5edb17356a7375fff24e36e53cc2749c78fb11af",
                    year = 2019,
                    cache_table=T,
                    survey="acs1"
                    )
      
      temp_acs1_df  %>% rex_clean() %>% arrow::write_parquet(outfile)
    })
  }
}

temp_acs1_df_all <- arrow::open_dataset(sources="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/acs1/") %>% collect() %>% mutate(dataset="acs5")
dim(temp_acs1_df_all) #86,502,080

setdiff(vars_acs1$name,vars_acs5$name) %>% length() #8662
setdiff(vars_acs5$name, vars_acs1$name) %>% length() #174

vars1 <- temp_acs1_df_all$variable %>% unique()
vars2 <- temp_acs5_df_all$variable %>% unique()

tables_acsboth <- rbind(temp_acs1_df_all,temp_acs5_df_all) %>% distinct() #1
dim(tables_acsboth) #180,840,520        5  180 million

vars_all <- bind_rows(vars_acs1, vars_acs5) %>% distinct() #35,702

vars_all_clean <- vars_all %>% 
                  mutate(description = concept  %>% paste0(", ",  label %>% str_replace_all("Estimate!!","") %>% str_replace_all(":!!",", ") %>% str_replace_all(":","") %>% str_replace_all("!!","")   ) %>% str_to_sentence()  ) %>%
                  mutate(variable= paste0("acs_",description,"_",name) %>% tolower() %>% str_replace_all(" ","_") %>% janitor::make_clean_names()  ) %>% 
                  rename(variable_short=name)

acs_raw <- tables_acsboth %>% clean_names() %>% rename(variable_short=variable) %>%
                 left_join(vars_all_clean %>% clean_names() )  %>%
                 mutate(fips=geoid, value=estimate) %>%
                 dplyr::select(fips, variable, variable_short, description, value, dataset) %>%
                 mutate(variable_short_group= variable_short %>% str_split_fixed(pattern="_", n=2) %>% .[,1] %>% paste0("_",dataset)  ) %>% 
                 mutate(variable=paste0(variable,"_",dataset)) %>%
                 filter(!is.na(value))
gc()
#for some reason the memory requirements expload for this

acs_pop <- acs_raw %>% filter(description=="Sex by age, total") %>% distinct()
rhs_acs_percent <- acs_raw  %>%
                   filter(!description %>% str_detect("income|dollars|minutes|rooms|hours|value|structure|facilities")) %>%
                   left_join(acs_pop %>% dplyr::select(fips, pop_acs=value) %>% distinct() ) %>%
                   mutate(value= value/pop_acs ) %>%
                   mutate(description=paste0("percent ", description)) %>%
                   mutate(variable=paste0(variable, "_perc")) %>%
                   filter(!is.na(value)) %>% 
                   filter(value<1) %>% #drop anything that equals 1
                   dplyr::select(-pop_acs)

rhs_acs_48029 <- rhs_acs_onlypop %>% filter(fips==48029)
rhs_acs_percent_48029 <- rhs_acs_percent %>% filter(fips==48029)

rhs_acs_percent  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_acs_percent.parquet"))


#rhs_census_2020  <- arrow::read_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020_actual.parquet"))
#
#rhs_acs_percent_absolute_normalized_by2020_observed <- acs_raw  %>%
#                                                       filter(!description %>% str_detect("income|dollars|minutes|rooms|hours|value|structure|facilities")) %>%
#                                                       left_join(acs_pop %>% dplyr::select(fips, pop_acs=value) %>% distinct() ) %>%
#                                                       mutate(value= value/pop_acs ) %>% #here we divide the ACS data by the ACS's total population count
#                                                       filter(!is.na(value)) %>% 
#                                                       filter(value<1) %>% #drop anything that equals 1
#                                                       dplyr::select(-pop_acs) %>%
#                                                       mutate(fips=as.numeric(fips)) %>%
#                                                       left_join(rhs_census_2020 %>% filter(variable=="pop") %>% dplyr::select(fips,pop_observed=value) %>% mutate(fips=as.numeric(fips)) %>% distinct() ) %>%
#                                                       mutate(value=value*pop_observed) %>% #here we multiply that proportion by the 2020 observed hoping it gets us close to the real number
#                                                       dplyr::select(-pop_observed)
#
#rhs_acs_percent_absolute_normalized_by2020_observed  %>% rex_clean() %>% 
#  arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_acs.parquet"))
#
#gc()



```






### BEA

```{r}
#BEA County Level Economic Measures
#https://apps.bea.gov/regional/downloadzip.cfm

fnames <- list.files("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/CAGDP2/", pattern = "csv", full.names = T)
bea <- lapply(fnames, fread, sep=",",fill=T) 

for(i in 1:length(bea)){
  bea[[i]] <- bea[[i]] %>% janitor::clean_names() %>%  dplyr::select(fips=geo_fips, description, x2019) %>% mutate(fips=as.numeric(fips))  %>% mutate(x2019=as.numeric(x2019)) %>% dplyr::filter(!is.na(fips))
}
rhs_bea <- bea %>%
            bind_rows() %>%
            distinct() %>% 
            dplyr::filter(fips>0 & !is.na(description) & description!='' & !is.na(x2019)) %>% 
            dplyr::filter(!duplicated(paste(fips, description))  ) %>%
            mutate(description=trimws(tolower(description))) %>%
            mutate(variable = paste0("bae_gdp_in_", description)) %>%
            mutate(description = paste0("GDP in ", description)) %>%
            mutate(dataset="bae") %>%
            rename(value=x2019)

rhs_bea  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_bea.parquet"))

rhs_bea_perc <- rhs_bea %>% group_by(fips) %>% mutate(value=round(value/max(value), 3)) %>% ungroup() %>% mutate(description=paste0("percent ", description)) %>% mutate(variable=paste0(variable, "_perc")) 

rhs_bea_perc  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_bea_perc.parquet"))


```



## Quarterly Census of Employment and Wages
https://www.bls.gov/cew/downloadable-data-files.htm

```{r}

#I think what we do here is subset industry_code , supersectpr, or sector but not 3 to 6 digit disagg, and then we just want the number of employees in each 
#annual_avg_emplvl  #average number of employees in that sector in 2020
#oty_annual_avg_emplvl_pct_chg  #percent change from 2019

files <- list.files(path = "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/2020.annual.by_area/", pattern = NULL, all.files = FALSE,
           full.names = T, recursive = FALSE,
           ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
quaterly_census_of_employment <- lapply(files, fread) %>% rbindlist()
dim(quaterly_census_of_employment) #3,598,270

quaterly_census_of_employment_sector <- quaterly_census_of_employment %>% filter(agglvl_title %>% str_detect("NAICS Sector|State, Total Covered") ) %>% dplyr::select(area_fips, industry_title, own_title, annual_avg_emplvl)
quaterly_census_of_employment_sector_perc_change <- quaterly_census_of_employment %>% filter(agglvl_title %>% str_detect("NAICS Sector|State, Total Covered") ) %>% dplyr::select(area_fips, industry_title, own_title, oty_annual_avg_emplvl_pct_chg)

quaterly_census_of_employment_sector_perc_change %>% ggplot(aes(x=industry_title,y=oty_annual_avg_emplvl_pct_chg)) + geom_boxplot() + coord_flip() + ylim(-50, 50)

quaterly_census_of_employment_sector_long <- quaterly_census_of_employment_sector %>% 
                                             mutate(description=paste0("people employed by ",own_title, " in ", industry_title)) %>%
                                             mutate(variable = paste0("cew_employed_",industry_title,"_",own_title)) %>%
                                             select(fips=area_fips,
                                                    variable,
                                                    description,
                                                    value=annual_avg_emplvl
                                                    ) %>% mutate(dataset="cew")


quaterly_census_of_employment_perc_chang_long <- quaterly_census_of_employment_sector_perc_change %>% 
                                               mutate(description=paste0("percent change in people employed by ",own_title, " in ", industry_title)) %>%
                                               mutate(variable = paste0("cew_percent_change_employed_",industry_title,"_",own_title)) %>%
                                               select(fips=area_fips,
                                                      variable,
                                                      description,
                                                      value=oty_annual_avg_emplvl_pct_chg
                                                      ) %>% mutate(dataset="cew")


rhs_cew <- bind_rows(quaterly_census_of_employment_sector_long, quaterly_census_of_employment_perc_chang_long)
rhs_cew %>% dplyr::select(fips, variable) %>% dim() == rhs_cew %>% dplyr::select(fips, variable) %>% unique() %>% dim()
rhs_cew  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_cew.parquet"))


rhs_cew_perc <- quaterly_census_of_employment_sector_long %>% group_by(fips) %>% mutate(value=round(value/max(value), 3)) %>% ungroup() %>%
                                                        mutate(description=paste0("percent ", description)) %>% mutate(variable=paste0(variable, "_perc")) 

rhs_cew_perc %>% dplyr::select(fips, variable) %>% dim() == rhs_cew_perc %>% dplyr::select(fips, variable) %>% unique() %>% dim()

rhs_cew_perc  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_cew_perc.parquet"))


```

## Politics

```{r}

politics <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/countypres_2000-2020.csv")

temp1 <- politics %>% filter(mode=="TOTAL", party=="REPUBLICAN") %>% 
        mutate(percent=candidatevotes/totalvotes) %>% 
        mutate(candidate_year= candidate %>% tolower() %>% str_replace_all(" ","_")  %>% str_replace_all("[^a-z]","") %>% paste0("_",year) ) %>% 
        dplyr::select(county_fips, percent,candidatevotes, candidate_year) %>%
        filter(!is.na(county_fips)) 

temp2 <- politics %>% filter(mode!="TOTAL", party=="REPUBLICAN" & year==2020) %>% 
          mutate(candidate_year= candidate %>% tolower() %>% str_replace_all(" ","_")  %>% str_replace_all("[^a-z]","") %>% paste0("_",year) ) %>% 
          group_by(county_fips, candidate_year) %>%
          summarise(candidatevotes=sum(candidatevotes), totalvotes=max(totalvotes)) %>%
          mutate(percent=candidatevotes/totalvotes) %>% 
          dplyr::select(county_fips, percent,candidatevotes,candidate_year) %>%
          filter(!is.na(county_fips)) 

politics_share <- bind_rows(temp1,temp2) %>%
                  dplyr::filter(!duplicated(paste0(county_fips,candidate_year))) %>% 
                  tidyr::pivot_wider(id_cols=county_fips, names_from=candidate_year,values_from=percent) %>% rename(fips=county_fips)

politics_votes <- bind_rows(temp1,temp2) %>%
                  dplyr::filter(!duplicated(paste0(county_fips,candidate_year))) %>%
                  tidyr::pivot_wider(id_cols=county_fips, names_from=candidate_year,values_from=candidatevotes) %>% rename(fips=county_fips)


rhs_politics <- cbind(politics_share %>% rename_at(vars(-fips), paste0, "_perc") #,
                      #politics_votes %>% rename_at(vars(-fips), paste0, "_votes") %>% dplyr::select(-fips)
                      ) %>%
                      rename_at(vars(-fips),function(x){paste0("politics_", x)})

rhs_politics_long <- rhs_politics %>% pivot_longer(-fips) %>% 
                       mutate(description = name) %>% 
                        mutate(dataset="MIT Election Data and Science Lab, 2018, County Presidential Election Returns 2000-2020") %>% dplyr::rename(variable=name)

rhs_politics_long  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_politics_long.parquet"))



```

## NYT Masking

```{r, message = FALSE, results=F}

#https://github.com/nytimes/covid-19-data/tree/master/mask-use
masking <- fread("https://raw.githubusercontent.com/nytimes/covid-19-data/master/mask-use/mask-use-by-county.csv") 
rhs_masking <- masking %>% 
                    janitor::clean_names() %>%
                    dplyr::select(fips=countyfp ,
                                   masking_never=never ,
                                   masking_rarely=rarely,
                                   masking_sometimes=sometimes ,
                                   masking_frequently=frequently ,
                                   masking_always=always
                                   ) %>% 
                  pivot_longer(-fips) %>%
                  mutate(description=paste0("percent of people who self report ",name)) %>%
                  mutate(variable=paste0("nyt_masking_",name)) %>% dplyr::select(-name) %>% mutate(dataset="NYT")
                 
rhs_masking  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_masking.parquet"))


```


### covidcast

I think what we do here is add the hesitancy in December question that's
available for 768 counties as a predictor. We form some hypothesis and
finish by taking them to the data for the 369 with specific reasons
which is present day

```{r}
p_load(covidcast)
p_load(dplyr)
#Already been or want to 
#smoothed_wcovid_vaccinated_or_accept	
#Discontinued as of Wave 11, May 19, 2021 Estimated percentage of respondents who either have already received a COVID vaccine or would definitely or probably choose to get vaccinated, if a vaccine were offered to them today.
#Earliest date available: 2021-01-06
smoothed_wcovid_vaccinated_or_accept <- suppressMessages(covidcast_signal(data_source = "fb-survey", signal = c("smoothed_wcovid_vaccinated_or_accept"),start_day = "2020-11-01", end_day = "2021-07-01",geo_type = "county"))
#table(smoothed_wcovid_vaccinated_or_accept$geo_value) #only available for 768 counties

#Only available for 739 counties
smoothed_wcovid_vaccinated_or_accept$geo_value %>% unique() %>% length() #768
rhs_delphi <- smoothed_wcovid_vaccinated_or_accept %>% 
                                              filter(time_value<=as.Date("2021-01-07")) %>%
                                              select(fips=geo_value, smoothed_wcovid_vaccinated_or_accept=value) %>%
                                              group_by(fips) %>%
                                              summarise(smoothed_wcovid_vaccinated_or_accept=mean(smoothed_wcovid_vaccinated_or_accept, na.rm=T)) %>%
                                              mutate(description="percent of people self report would accept vaccination") %>%
                                              mutate(variable="delphi_fb_percent_accept_vaccination") %>%
                                              rename(value=smoothed_wcovid_vaccinated_or_accept) %>%
                                              mutate(dataset="delphi_fb")
  

rhs_delphi  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_delphi.parquet"))


```

## Safegraph

```{r}

#County Flows
fnames <- list.files("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_temp/COVID19USFlows/weekly_flows/county2county", pattern = "csv", full.names = T)
flows_county2county <- rbindlist(lapply(fnames, fread), fill=T) %>% 
                         mutate(date_range_start=date_range %>% stringr::str_split(" - ", simplify=T) %>% .[,1] %>% as.Date()) %>%
                                      filter(date_range_start<=as.Date("2020-11-04")) #cutoff at the election
#25,543,608

#These are pop flows from A to A
flows_county2county_selfvisits <- flows_county2county %>% dplyr::filter(geoid_o==geoid_d) %>% 
                                  group_by(fips=geoid_o) %>%
                                  summarise(population_flows_self_total=sum(pop_flows))


#These are pop flows from A to B
flows_county2county_externalvisits <- flows_county2county %>% dplyr::filter(geoid_o!=geoid_d)   %>% 
                                      group_by(fips=geoid_o) %>%
                                      summarise(population_flows_external_total=sum(pop_flows))

#These are pop flows from B to A
flows_county2county_fromexternalvisits <- flows_county2county %>% dplyr::filter(geoid_o!=geoid_d) %>% 
                                      filter(date_range_start<=as.Date("2020-11-04")) %>% 
                                      group_by(fips=geoid_d) %>%
                                      summarise(population_flows_from_external_total=sum(pop_flows))

safegraph <- flows_county2county_selfvisits %>% 
             full_join(flows_county2county_externalvisits) %>%
             full_join(flows_county2county_fromexternalvisits) 


rhs_safegraph <- safegraph %>% 
                 mutate(population_flows_external_ratio_to_internal = population_flows_external_total/population_flows_self_total) %>%
                 mutate(population_flows_from_external_total_ratio_to_internal = population_flows_from_external_total/population_flows_self_total) %>%
                 mutate(population_flows_ratio_in_to_out = population_flows_external_total/population_flows_from_external_total) %>% 
                 pivot_longer(-fips) %>%
                 mutate(description=paste0("mobility ", name)) %>%
                 mutate(variable=paste0("safegraph_", name)) %>%
                 mutate(dataset="safegraph") %>% dplyr::select(-name)

rhs_safegraph  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_safegraph.parquet"))


```  
## Infections

```{r}

fnames <- list.files("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_temp/covid19-infection-estimates-latest/counties", pattern = "^latest_", full.names = T)
covid <- rbindlist(lapply(fnames, fread), fill=T)

covid_counts <- covid %>% dplyr::filter(date==as.Date("2020-11-04"))  %>%
                    dplyr::select(fips, total_deaths, total_cases, total_infected_mean) %>%
                    mutate(ratio_estimated_cases_to_measured=total_infected_mean/total_cases)

rhs_covid <-     covid_counts %>% pivot_longer(-fips) %>%
                 mutate(description=paste0("COVID infections ", name)) %>%
                 mutate(variable=paste0("covid19projections_", name)) %>%
                 mutate(dataset="covid19projections") %>% dplyr::select(-name)

rhs_covid  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_covid.parquet"))

```

## Geography

```{r}

p_load(rnaturalearth)
p_load(rnaturalearthdata)
coastlines <- ne_coastline(scale = 110, returnclass = c("sf"))
#counties_tigris_sf <- tigris::counties(state = NULL, cb = FALSE, resolution = "5m", year = 2019)

#gg <- ggplot()
#gg <- gg + geom_sf(data = counties_sf, color="black",
#                   fill="white", size=0.25)
#gg


```

### Google Mobility

```{r}

google_mobility2020 <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/2020_US_Region_Mobility_Report.csv")
google_mobility2021 <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/2021_US_Region_Mobility_Report.csv")

google_mobility <- bind_rows(google_mobility2020, google_mobility2021 )
rhs_googlemobility <- google_mobility %>% rename(fips=census_fips_code) %>%
                          filter(date<=as.Date("2020-11-04")) %>% #cutoff at the election
                          group_by(fips) %>%
                          summarize_if(is.numeric, mean, na.rm=T) %>% 
                          mutate_if(is.numeric, ~replace(., is.nan(.), NA))  %>% 
                         pivot_longer(-fips) %>%
                           mutate(description=paste0("mobility ", name)) %>%
                           mutate(variable=paste0("google_", name)) %>%
                           mutate(dataset="google") %>% dplyr::select(-name)


rhs_googlemobility  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_googlemobility.parquet"))


```

### GEography 

```{r, eval=F}
distance_to_coast <- st_distance(
  x=counties_sf_tigris %>% st_transform(crs = st_crs(coastlines)),
  y=coastlines %>% st_combine(),
  by_element = T
  )

distance_to_coast_df <- counties_sf_tigris %>% as.data.frame()  %>% dplyr::mutate(fips= paste0(STATEFP,COUNTYFP) %>% as.numeric()) %>% mutate(distance_to_coast_km= as.numeric(distance_to_coast/1000)) %>% dplyr::select(fips, distance_to_coast_km)
```

### Vaccine Providers

```{r}

#Vaccine Providers
#https://github.com/GoogleCloudPlatform/covid-19-open-data/blob/main/docs/table-vaccination-access.md
facilities <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/facility-boundary-us-all.csv")

facilities_small <- facilities %>% dplyr::select(-facility_catchment_boundary, -mode_of_transportation, -travel_time_threshold_minutes) %>% distinct() #
dim(facilities_small) #55544    12

rhs_covidfacilities <- facilities_small %>% group_by(fips=facility_sub_region_2_code) %>%
                          summarise(vaccine_facilities_count=n()) %>% 
                         pivot_longer(-fips) %>%
                           mutate(description=paste0("supply ", name)) %>%
                           mutate(variable=paste0("google_", name)) %>%
                           mutate(dataset="google") %>% dplyr::select(-name)


rhs_covidfacilities  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_covidfacilities.parquet"))


```


### Vaccine Distributors (vaccines.gov)

```{r}

vaccines_gov <- fread("https://data.cdc.gov/api/views/5jp2-pgaw/rows.csv?accessType=DOWNLOAD")

vaccines_gov_counties <- vaccines_gov %>% 
                          filter(!is.na(latitude)) %>% #there's a handful missing latlong
                          st_as_sf(coords=c('longitude','latitude'), crs=st_crs(counties_sf_tigris)) %>%
                          st_join(counties_sf_tigris %>% dplyr::select(fips=GEOID))

rhs_vaccines_gov_counties <- 
vaccines_gov_counties %>% as.data.frame() %>%
  group_by(fips) %>% 
  summarise(supply_locations = sum(!is.na(provider_location_guid), na.rm=T),
            supply_locations_instock = sum(in_stock, na.rm=T),
            supply_locations_walkin = sum( walkins_accepted, na.rm=T),
            supply_locations_insurance = sum( walkins_accepted, na.rm=T),
            supply_locations_instock_walkin = sum(in_stock & walkins_accepted, na.rm=T),
            supply_locations_instock_insurance = sum(in_stock & walkins_accepted, na.rm=T),
            ) %>%
          pivot_longer(-fips) %>%
           mutate(description=paste0("vaccine ", name)) %>%
           mutate(variable=paste0("vaccinedotgov_", name)) %>%
           mutate(dataset="vaccinedotgov") %>% dplyr::select(-name)


rhs_vaccines_gov_counties  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_vaccines_gov_counties.parquet"))

```

## countyhealthrankings

```{r}

#https://www.countyhealthrankings.org/explore-health-rankings/rankings-data-documentation
a00 <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/countyhealthrankings/analytic_data2021.csv") %>% clean_names()

#On how they get county estimates when the unit is MMSA
#https://www.cdc.gov/brfss/smart/smart_faq.htm
#Obtaining local data from Behavior Risk Factor Surveillance System (BRFSS)
#https://www.citymatch.org/wp-content/uploads/2018/12/Obtaining-local-data-from-Behavior-Risk-Factor-Surveillance.pdf

rhs_countyhealthrankings <- a00 %>% dplyr::select(
  fips=x5_digit_fips_code, 
  poor_or_fair_health_perc_brfss2018 = poor_or_fair_health_raw_value,
  low_birthweight_perc_nchs2019=low_birthweight_raw_value,
  adult_smoking_perc_brfss2018=adult_smoking_raw_value,
  adult_obesity_perc_dss2017=adult_obesity_raw_value, #United States Diabetes Surveillance System
  uninsured_perc_sahi2018 =uninsured_raw_value, #Small Area Health Insurance Estimates
  primary_care_physicians_percap_2018 =primary_care_physicians_raw_value, #Area Health Resource File/American Medical Association
  dentists_percap_2019 =dentists_raw_value, #Area Health Resource File/National Provider Identification file
  mental_health_providers_percap_2020 =mental_health_providers_raw_value , #CMS National Provider Identification
  preventable_hospital_stays_percap2018 =preventable_hospital_stays_raw_value, #Rate of hospital stays for ambulatory-care sensitive conditions per 100,000 Medicare enrollees.
  mammography_screening_percap2018 =mammography_screening_raw_value, #Percentage of female Medicare enrollees ages 65-74 that received an annual mammography screening.
  flu_vaccinations_perc_medicare2018 =flu_vaccinations_raw_value #Percentage of fee-for-service (FFS) Medicare enrollees that had an annual flu vaccination.
) %>%
  pivot_longer(-fips) %>%
   mutate(description=paste0("", name)) %>%
   mutate(variable=paste0("countyhealthrankings_", name)) %>%
   mutate(dataset="countyhealthrankings") %>% dplyr::select(-name)

rhs_countyhealthrankings  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_countyhealthrankings.parquet"))


```

##

```{r, eval=F}

a0 <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/Vaccination_Coverage_among_Young_Children__0-35_Months_.csv") %>% clean_names()

a0_clean <- a0 %>% mutate(vaccinated=estimate_percent*sample_size) %>% group_by(vaccine, geography) %>% summarise(vaccinated=sum(vaccinated), sample_size=sum(sample_size)) %>% mutate(vaccinated_perc=vaccinated/sample_size)
table(a0_clean$vaccine, a0_clean$geography) #There's a couple of vaccines missing at the count and PR level but the states have all of them.

a0_clean_state <- a0 %>% mutate(vaccinated=estimate_percent*sample_size) %>% group_by(geography) %>% summarise(vaccinated=sum(vaccinated), sample_size=sum(sample_size)) %>% mutate(vaccinated_perc=vaccinated/sample_size)

#hist(a0_clean_state$vaccinated_perc)

state_previous_child_vaccinated_perc <- a0_clean_state %>% dplyr::select(name_state=geography, previous_child_vaccinated_perc=vaccinated_perc) %>%
  left_join(states_sf_tigris %>% mutate(fips_state=as.numeric(STATEFP)*1000) %>% as.data.frame() %>% dplyr::select(name_state=NAME,fips_state) ) %>% dplyr::filter(!is.na(fips_state))

#a <- fread("1976-2020-president.csv")

a <- fread("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv") %>%
     filter(date=="2020-11-04") %>% dplyr::select(fips, deaths)

#b <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/2012pres.csv") %>% clean_names() %>%
#     mutate(romney_perc=100*willard_mitt_romney / (barack_h_obama + willard_mitt_romney)) %>%
#    dplyr::select(fips,romney_perc)

#c <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/2020pres.csv") %>% clean_names() %>% 
#     mutate(trump_perc=100*donald_j_trump / (joseph_r_biden_jr + donald_j_trump)) %>%
#     dplyr::select(fips,trump_perc)

#Don't need anymore
#d <- readRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/cc-est2019-alldata.Rds") %>% clean_names() %>%
#     filter(year==12, agegrp==0) %>%
#     mutate(black_perc = 100*(bac_male + bac_female)/tot_pop) %>%
#     mutate(native_perc = 100*(iac_male + iac_female)/tot_pop) %>%
#     mutate(hispanic_perc = 100*(h_male + h_female)/tot_pop) %>%
#     mutate(fips=paste0(state,str_pad(county, 3, pad = "0") ) %>% as.numeric()  ) %>%
#     dplyr::select(fips,tot_pop,black_perc,native_perc,hispanic_perc, state_name=stname, county_name=ctyname)
```

Skipping this bad old measure of rural

```{r, eval=F}
library(readxl)
g <- read_excel("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/ruralurbancodes2013.xls") %>% clean_names() %>% dplyr::select(fips,rucc_2013) %>%
     mutate(fips=fips %>% as.numeric()) 
dim(g)
```


Skipping this in favor some of spatial thing we'll try later
```{r, eval=F}
population_differential <- dyad_df %>% 
                            left_join(h %>% dplyr::select(fips_x=fips, population_total_x=population_total)) %>%
                            left_join(h %>% dplyr::select(fips_y=fips, population_total_y=population_total)) %>%
                            mutate(population_differential=population_total_x/population_total_y) %>%
                            group_by(fips=fips_x) %>%
                            summarise(population_differential=min(population_differential, na.rm=T)) %>%
                            filter(is.finite(population_differential))

```




### VA Data

Locked on July 14

```{r}

#install.packages("remotes")
#remotes::install_github("michaeldorman/mapsapi")
if(fromscratch){
  counties_sf_tigris <- tigris::counties(state = NULL, cb = FALSE, resolution = "5m", year = 2019) %>% mutate(fips=paste0(STATEFP, COUNTYFP) %>% as.numeric) %>% arrange(fips)

  vacovid19summary <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vacovid19summary.csv") %>% janitor::clean_names()

  library(mapsapi)
  key = "AIzaSyDbc5p1Zio0hRmc74pZrCi5BExAjSLZtFw"
  place_list <- list()
  for(q in vacovid19summary$facility_name){
   print(q)
    doc = mp_geocode(
      addresses = q,
      key = key,
      quiet = TRUE
    )
    pnt = mp_get_points(doc)
    result <- pnt %>% st_transform(st_crs(counties_sf_tigris)) %>% st_join(counties_sf_tigris)
    result$facility_name <- q
    place_list[[q]] <- result
  }
  vacovid19summary_geolocated <- vacovid19summary %>% left_join( bind_rows(place_list))
  saveRDS(vacovid19summary_geolocated, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vacovid19summary_geolocated.Rds")

}

vacovid19summary_geolocated_clean <- readRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vacovid19summary_geolocated.Rds") %>% clean_names() %>%
                                      mutate(people_partial_va=dose_1_of_2_pfizer_or_moderna+dose_1_of_1_janssen,
                                      people_complete_va= dose_2_of_2_pfizer_or_moderna+dose_1_of_1_janssen)  %>%
                                     group_by(fips) %>%
                                    summarise(people_partial_va=sum(people_partial_va), people_complete_va=sum(people_complete_va))
#3,480,642 #3.4 million

rhs_vacovid19summary_geolocated  <- vacovid19summary_geolocated_clean  %>% 
                                    pivot_longer(-fips) %>% 
                                    mutate(description=ifelse(name=='people_partial_va','vaccinations through veterans affairs people partially vaccinated','vaccinations through veterans affairs people fully vaccinated')) %>%
                                    mutate(variable=ifelse(name=='people_partial_va','vaccinated_partially_through_va','vaccinated_fully_through_va')) %>%
                                    mutate(dataset="veterans_affairs")
  

rhs_vacovid19summary_geolocated  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_vacovid19summary_geolocated.parquet"))


```

### JHU State Data

Ok so what I think we do is sum up everything we have for all the counties. Calculate the difference between the state total and that. Distribute the difference proportionally by population to the counties in that state. And then add the VA numbers right at the end. That should give us everything minus the DOD.

```{r}

if(fromscratch){
  jhu <- fread("https://raw.githubusercontent.com/govex/COVID-19/master/data_tables/vaccine_data/us_data/hourly/vaccine_people_vaccinated_US.csv")
  saveRDS(jhu, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vacovid19summary.Rds")
}
rhs_jhu_state <- readRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vacovid19summary.Rds")

#Don't save this to the RHS folder without more modifications
#rhs_jhu_state  %>% 
  #rex_clean() %>%  #not ready yet
  #arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_jhu_state.parquet"))


```


### Religion

U.S. Religion Census: Religious Congregations and Membership Study, 2010 (County File)
https://www.thearda.com/Archive/Files/Descriptions/RCMSCY10.asp

```{r}

thearda_codebook <- data.frame(
  stringsAsFactors = FALSE,
          variable = c("1) TOTCNG","10) MPRTCNG",
                       "100) BCCCNG","101) BRUDCNG","102) BRUDADH",
                       "103) BRUDRATE","104) BUDMCNG","105) BUDMADH","106) BUDMRATE",
                       "107) BUDTCNG","108) BUDTADH","109) BUDTRATE",
                       "11) MPRTADH","110) BUDVCNG","111) BUDVADH","112) BUDVRATE",
                       "113) BULGCNG","114) BULGADH","115) BULGRATE",
                       "116) CCFCCNG","117) CARCCNG","118) CTHCNG","119) CTHADH",
                       "12) MPRTRATE","120) CTHRATE","121) CYMFCNG","122) CYMFADH",
                       "123) CYMFRATE","124) CMACNG","125) CMAADH",
                       "126) CMARATE","127) CBCNG","128) CCDCCNG","129) CCDCADH",
                       "13) CATHCNG","130) CCDCRATE","131) CCCCCNG","132) CCCCADH",
                       "133) CCCCRATE","134) CMECNG","135) CMEADH",
                       "136) CMERATE","137) CRCCNG","138) CRCADH","139) CRCRATE",
                       "14) CATHADH","140) CUCNG","141) CCHCNG","142) CCSCNG",
                       "143) CGAICNG","144) CGAIADH","145) CGAIRATE",
                       "146) CGCTCNG","147) CGCTADH","148) CGCTRATE","149) CG7DCNG",
                       "15) CATHRATE","150) CGFCNG","151) CGGCCNG",
                       "152) CGGCADH","153) CGGCRATE","154) CGCCNG","155) CGCADH",
                       "156) CGCRATE","157) CGCMCNG","158) CGCMADH","159) CGCMRATE",
                       "16) ORTHCNG","160) CGPCNG","161) CGPADH",
                       "162) CGPRATE","163) CGAFCNG","164) CGMACNG","165) LDSCNG",
                       "166) LDSADH","167) LDSRATE","168) CAFCNG","169) CBRCNG",
                       "17) ORTHADH","170) CBRADH","171) CBRRATE",
                       "172) CLBACNG","173) CLBAADH","174) CLBARATE","175) CLCCNG",
                       "176) NAZCNG","177) NAZADH","178) NAZRATE","179) CUBCCNG",
                       "18) ORTHRATE","180) CUBCADH","181) CUBCRATE",
                       "182) CHCHCNG","183) CHCHADH","184) CHCHRATE","185) CCCUCNG",
                       "186) CHGNCNG","187) CHGNADH","188) CHGNRATE",
                       "189) CRECCNG","19) OTHCNG","190) COCCNG","191) COCADH",
                       "192) COCRATE","193) CCCCNG","194) CCCADH","195) CCCRATE",
                       "196) CHCCNG","197) CHCADH","198) CHCRATE",
                       "199) CMCCNG","2) TOTADH","20) OTHADH","200) CMCADH",
                       "201) CMCRATE","202) CBACNG","203) CCONCNG","204) CCONADH",
                       "205) CCONRATE","206) CJUDCNG","207) CJUDADH",
                       "208) CJUDRATE","209) CLACNG","21) OTHRATE","210) CMCOCNG",
                       "211) CMCOADH","212) CMCORATE","213) CYFRCNG","214) CYFRADH",
                       "215) CYFRRATE","216) OFWBCNG","217) OFWBADH",
                       "218) OFWBRATE","219) CWCNG","22) OCGCNG","220) CWADH",
                       "221) CWRATE","222) COPTCNG","223) COPTADH",
                       "224) COPTRATE","225) CRPCCNG","226) CUMBCNG","227) CUMBADH",
                       "228) CUMBRATE","229) CPCACNG","23) AMECNG","230) ELIMCNG",
                       "231) EBACNG","232) ECCNG","233) ECADH","234) ECRATE",
                       "235) EOCNG","236) EOADH","237) EORATE",
                       "238) ETHOCNG","239) EARCNG","24) AMEADH","240) EVCHCNG",
                       "241) ECCCNG","242) ECCADH","243) ECCRATE","244) ECOVCNG",
                       "245) ECOVADH","246) ECOVRATE","247) EFCACNG",
                       "248) EFCAADH","249) EFCARATE","25) AMERATE","250) EFCICNG",
                       "251) EFCIADH","252) EFCIRATE","253) ELCACNG",
                       "254) ELCAADH","255) ELCARATE","256) ELSCNG","257) ELSADH",
                       "258) ELSRATE","259) EMCCNG","26) AMEZCNG","260) EPCCNG",
                       "261) EPCADH","262) EPCRATE","263) FRCCNG","264) FEBCCNG",
                       "265) FEBCADH","266) FEBCRATE","267) FECCNG",
                       "268) FECADH","269) FECRATE","27) AMEZADH","270) FOURCNG",
                       "271) FOURADH","272) FOURRATE","273) FCSCNG",
                       "274) FMCCNG","275) FMCADH","276) FMCRATE","277) FPCCNG",
                       "278) FRCHCNG","279) FRNDCNG","28) AMEZRATE","280) FRNDADH",
                       "281) FRNDRATE","282) FGCCNG","283) FGCADH",
                       "284) FGCRATE","285) FUMCNG","286) FUMADH","287) FUMRATE",
                       "288) FGBCNG","289) FBFCNG","29) ALBCNG","290) GARBCNG",
                       "291) GOPCNG","292) GOPADH","293) GOPRATE",
                       "294) FGBCCNG","295) GGFCNG","296) GRKCNG","297) GRKADH",
                       "298) GRKRATE","299) HRCCNG","3) TOTRATE","30) ALBADH",
                       "300) HRCADH","301) HRCRATE","302) HNICNG","303) HNIADH",
                       "304) HNIRATE","305) HNPRCNG","306) HNPRADH",
                       "307) HNPRRATE","308) HNRCNG","309) HNRADH","31) ALBRATE",
                       "310) HNRRATE","311) HNTTCNG","312) HNTTADH","313) HNTTRATE",
                       "314) HOCCNG","315) HOCADH","316) HOCRATE",
                       "317) HUNGCNG","318) HUTTCNG","319) IBFICNG","32) AWMCCNG",
                       "320) IFCACNG","321) IYMFCNG","322) IYMFADH",
                       "323) IYMFRATE","324) ICCCNG","325) ICCADH","326) ICCRATE",
                       "327) ICCCCNG","328) IFBCCNG","329) INTFCNG","33) AWMCADH",
                       "330) IPCCCNG","331) IPCCADH","332) IPCCRATE",
                       "333) IPHCCNG","334) IPHCADH","335) IPHCRATE","336) JAINCNG",
                       "337) JWCNG","338) KPRSCNG","339) KPCACNG",
                       "34) AWMCRATE","340) KAPCCNG","341) LCMSCNG","342) LCMSADH",
                       "343) LCMSRATE","344) LCMCCNG","345) LCMCADH",
                       "346) LCMCRATE","347) MOCCNG","348) MOCADH","349) MOCRATE",
                       "35) ALBPCNG","350) MALACNG","351) MALAADH","352) MALARATE",
                       "353) MOSCCNG","354) MOSCADH","355) MOSCRATE",
                       "356) MAMCNG","357) MAMADH","358) MAMRATE","359) MCFCNG",
                       "36) AMANCNG","360) MCFADH","361) MCFRATE","362) MENNCNG",
                       "363) MENNADH","364) MENNRATE","365) MCCCNG",
                       "366) MCCADH","367) MCCRATE","368) MBAMCNG","369) MBAMADH",
                       "37) AMANADH","370) MBAMRATE","371) MCCFCNG",
                       "372) MCCFADH","373) MCCFRATE","374) MISSCNG","375) MISSADH",
                       "376) MISSRATE","377) MVAKCNG","378) MVAKADH",
                       "379) MVAKRATE","38) AMANRATE","380) MVNOCNG","381) MVNOADH",
                       "382) MVNORATE","383) MVSOCNG","384) MVSOADH",
                       "385) MVSORATE","386) MSLMCNG","387) MSLMADH","388) MSLMRATE",
                       "389) NACCCNG","39) AAMCNG","390) NACCADH",
                       "391) NACCRATE","392) FWBCNG","393) FWBADH","394) FWBRATE",
                       "395) NBCACNG","396) NBCAADH","397) NBCARATE","398) NBCCNG",
                       "399) NBCADH","4) EVANCNG","40) AAMADH","400) NBCRATE",
                       "401) NMBCCNG","402) NMBCADH","403) NMBCRATE",
                       "404) NSACCNG","405) NWAPCNG","406) IBCCNG","407) NONDCNG",
                       "408) NONDADH","409) NONDRATE","41) AAMRATE",
                       "410) NABCCNG","411) NABCADH","412) NABCRATE","413) NALCCNG",
                       "414) OORBCNG","415) OORBADH","416) OORBRATE",
                       "417) OBSCCNG","418) OBSCADH","419) OBSCRATE","42) AALCCNG",
                       "420) OCACNG","421) OCAADH","422) OCARATE",
                       "423) OJUDCNG","424) OJUDADH","425) OJUDRATE","426) OPCCNG",
                       "427) OPCADH","428) OPCRATE","429) ROCCNG","43) ABACNG",
                       "430) ROCADH","431) ROCRATE","432) PCCCNG","433) PCCADH",
                       "434) PCCRATE","435) FBHCCNG","436) PFWBCNG",
                       "437) PILLCNG","438) PILLADH","439) PILLRATE","44) ABAADH",
                       "440) PNCCCNG","441) PCCNG","442) PCADH","443) PCRATE",
                       "444) PCACNG","445) PCAADH","446) PCARATE",
                       "447) PRCCNG","448) PBEDCNG","449) PBEDADH","45) ABARATE",
                       "450) PBEDRATE","451) PMCCNG","452) PNBCCNG","453) PNBCADH",
                       "454) PNBCRATE","455) PRCACNG","456) PRCAADH",
                       "457) PRCARATE","458) RJUDCNG","459) RJUDADH","46) ABCCNG",
                       "460) RJUDRATE","461) RFRMCNG","462) RFRMADH",
                       "463) RFRMRATE","464) RBCCNG","465) RCACNG","466) RCAADH",
                       "467) RCARATE","468) RCUSCNG","469) RCUSADH","47) ABCADH",
                       "470) RCUSRATE","471) RMCCNG","472) RMCADH",
                       "473) RMCRATE","474) RPCCNGV","475) RPHPCNG","476) RPUSCNG",
                       "477) RPNACNG","478) RPNAADH","479) RPNARATE",
                       "48) ABCRATE","480) ROAACNG","481) ROAAADH","482) ROAARATE",
                       "483) ROORCNG","484) ROORADH","485) ROORRATE",
                       "486) SALVCNG","487) SALVADH","488) SALVRATE","489) SCHWCNG",
                       "49) ACROCNG","490) SCHWADH","491) SCHWRATE",
                       "492) SERBCNG","493) SERBADH","494) SERBRATE","495) SDBCNG",
                       "496) SDBADH","497) SDBRATE","498) SDACCNG","499) SDACADH",
                       "5) EVANADH","50) ACROADH","500) SDACRATE",
                       "501) SHNTCNG","502) SIKHCNG","503) SBCCNG","504) SBCADH",
                       "505) SBCRATE","506) SMCCNG","507) SWEDCNG","508) SOCACNG",
                       "509) SOCAADH","51) ACRORATE","510) SOCARATE",
                       "511) TAMCNG","512) TAMADH","513) TAMRATE","514) TAOCNG",
                       "515) USMBCNG","516) USMBADH","517) USMBRATE",
                       "518) UOCCNG","519) UOCADH","52) APCCNG","520) UOCRATE",
                       "521) UCAMCNG","522) UCAMADH","523) UCAMRATE","524) UFMCNG",
                       "525) UMJCCNG","526) UUACNG","527) UUAADH",
                       "528) UUARATE","529) UCTHCNG","53) AMSHCNG","530) UCTHADH",
                       "531) UCTHRATE","532) UCCCNG","533) UCCADH","534) UCCRATE",
                       "535) UHCACNG","536) UMCCNG","537) UMCADH",
                       "538) UMCRATE","539) UPCICNG","54) AMSHADH","540) UPCCNG",
                       "541) URCCNG","542) UZCCNG","543) UZCADH","544) UZCRATE",
                       "545) UNTYCNG","546) UNBRCNG","547) PJOCCNG",
                       "548) PJOCADH","549) PJOCRATE","55) AMSHRATE","550) VINECNG",
                       "551) VINEADH","552) VINERATE","553) WESCNG",
                       "554) WESADH","555) WESRATE","556) WELSCNG","557) WELSADH",
                       "558) WELSRATE","559) ZOROCNG","56) ACNACNG","560) ZOROADH",
                       "561) ZORORATE","562) FIPS","563) STCODE",
                       "564) STABBR","565) STNAME","566) CNTYCODE","567) CNTYNAME",
                       "568) POP2010","57) AOCACNG","58) AOCAADH","59) AOCARATE",
                       "6) EVANRATE","60) ACCACNG","61) ACCAADH",
                       "62) ACCARATE","63) AFMCNG","64) AFMADH","65) AFMRATE",
                       "66) ALCACNG","67) AACACNG","68) AACAADH","69) AACARATE",
                       "7) BPRTCNG","70) ARMCNG","71) ARMADH","72) ARMRATE",
                       "73) AECCNG","74) AGCNG","75) AGADH","76) AGRATE",
                       "77) AGIFCNG","78) ARPCCNG","79) ARPCADH","8) BPRTADH",
                       "80) ARPCRATE","81) AFLCCNG","82) AMCCNG","83) ARBCCNG",
                       "84) BAHCNG","85) BAHADH","86) BAHRATE","87) BAMCCNG",
                       "88) BAMCADH","89) BAMCRATE","9) BPRTRATE","90) BAMCNG",
                       "91) BAMADH","92) BAMRATE","93) BFCCNG","94) BFCADH",
                       "95) BFCRATE","96) BPCCNG","97) BCACNG","98) BCAADH",
                       "99) BCARATE"),
       description = c("All denominations/groups--Total number of congregations (2010)",
                       "Mainline Protestant--Total number of congregations (2010)",
                       "Brethren in Christ Church--Total number of congregations (2010)",
                       "Bruderhof Communities, Inc.--Total number of congregations (2010)",
                       "Bruderhof Communities, Inc.--Total number of adherents (2010)",
                       "Bruderhof Communities, Inc.--Rates of adherence per 1,000 population (2010)",
                       "Buddhism, Mahayana--Total number of congregations (2010)",
                       "Buddhism, Mahayana--Total number of adherents (2010)",
                       "Buddhism, Mahayana--Rates of adherence per 1,000 population (2010)",
                       "Buddhism, Theravada--Total number of congregations (2010)",
                       "Buddhism, Theravada--Total number of adherents (2010)",
                       "Buddhism, Theravada--Rates of adherence per 1,000 population (2010)",
                       "Mainline Protestant--Total number of adherents (2010)",
                       "Buddhism, Vajrayana--Total number of congregations (2010)",
                       "Buddhism, Vajrayana--Total number of adherents (2010)",
                       "Buddhism, Vajrayana--Rates of adherence per 1,000 population (2010)",
                       "Bulgarian Eastern Orthodox Diocese of the USA, Canada and Australia--Total number of congregations (2010)",
                       "Bulgarian Eastern Orthodox Diocese of the USA, Canada and Australia--Total number of adherents (2010)",
                       "Bulgarian Eastern Orthodox Diocese of the USA, Canada and Australia--Rates of adherence per 1,000 population (2010)",
                       "Calvary Chapel Fellowship Churches--Total number of congregations (2010)",
                       "Canadian and American Reformed Churches--Total number of congregations (2010)",
                       "Catholic Church--Total number of congregations (2010)","Catholic Church--Total number of adherents (2010)",
                       "Mainline Protestant--Rates of adherence per 1,000 population (2010)",
                       "Catholic Church--Rates of adherence per 1,000 population (2010)",
                       "Central Yearly Meeting of Friends--Total number of congregations (2010)",
                       "Central Yearly Meeting of Friends--Total number of adherents (2010)",
                       "Central Yearly Meeting of Friends--Rates of adherence per 1,000 population (2010)",
                       "Christian and Missionary Alliance, The--Total number of congregations (2010)",
                       "Christian and Missionary Alliance, The--Total number of adherents (2010)",
                       "Christian and Missionary Alliance, The--Rates of adherence per 1,000 population (2010)",
                       "Christian Brethren--Total number of congregations (2010)",
                       "Christian Church (Disciples of Christ)--Total number of congregations (2010)",
                       "Christian Church (Disciples of Christ)--Total number of adherents (2010)",
                       "Catholic--Total number of congregations (2010)",
                       "Christian Church (Disciples of Christ)--Rates of adherence per 1,000 population (2010)",
                       "Christian Churches and Churches of Christ--Total number of congregations (2010)",
                       "Christian Churches and Churches of Christ--Total number of adherents (2010)",
                       "Christian Churches and Churches of Christ--Rates of adherence per 1,000 population (2010)",
                       "Christian Methodist Episcopal Church--Total number of congregations (2010)",
                       "Christian Methodist Episcopal Church--Total number of adherents (2010)",
                       "Christian Methodist Episcopal Church--Rates of adherence per 1,000 population (2010)",
                       "Christian Reformed Church in North America--Total number of congregations (2010)",
                       "Christian Reformed Church in North America--Total number of adherents (2010)",
                       "Christian Reformed Church in North America--Rates of adherence per 1,000 population (2010)",
                       "Catholic--Total number of adherents (2010)",
                       "Christian Union--Total number of congregations (2010)",
                       "Church of Christ (Holiness), U.S.A.--Total number of congregations (2010)",
                       "Church of Christ, Scientist--Total number of congregations (2010)",
                       "Church of God (Anderson, Indiana)--Total number of congregations (2010)",
                       "Church of God (Anderson, Indiana)--Total number of adherents (2010)",
                       "Church of God (Anderson, Indiana)--Rates of adherence per 1,000 population (2010)",
                       "Church of God (Cleveland, Tennessee)--Total number of congregations (2010)",
                       "Church of God (Cleveland, Tennessee)--Total number of adherents (2010)",
                       "Church of God (Cleveland, Tennessee)--Rates of adherence per 1,000 population (2010)",
                       "Church of God (Seventh Day)--Total number of congregations (2010)",
                       "Catholic--Rates of adherence per 1,000 population (2010)",
                       "Church of God by Faith, Inc.--Total number of congregations (2010)",
                       "Church of God General Conference--Total number of congregations (2010)",
                       "Church of God General Conference--Total number of adherents (2010)",
                       "Church of God General Conference--Rates of adherence per 1,000 population (2010)",
                       "Church of God in Christ--Total number of congregations (2010)",
                       "Church of God in Christ--Total number of adherents (2010)",
                       "Church of God in Christ--Rates of adherence per 1,000 population (2010)",
                       "Church of God in Christ, Mennonite--Total number of congregations (2010)",
                       "Church of God in Christ, Mennonite--Total number of adherents (2010)",
                       "Church of God in Christ, Mennonite--Rates of adherence per 1,000 population (2010)",
                       "Orthodox--Total number of congregations (2010)",
                       "Church of God of Prophecy--Total number of congregations (2010)",
                       "Church of God of Prophecy--Total number of adherents (2010)",
                       "Church of God of Prophecy--Rates of adherence per 1,000 population (2010)",
                       "Church of God of the Apostolic Faith, Inc.--Total number of congregations (2010)",
                       "Church of God, Mountain Assembly, Inc.--Total number of congregations (2010)",
                       "Church of Jesus Christ of Latter-day Saints, The--Total number of congregations (2010)",
                       "Church of Jesus Christ of Latter-day Saints, The--Total number of adherents (2010)",
                       "Church of Jesus Christ of Latter-day Saints, The--Rates of adherence per 1,000 population (2010)",
                       "Church of Our Lord Jesus Christ of the Apostolic Faith, Inc.--Total number of congregations (2010)",
                       "Church of the Brethren--Total number of congregations (2010)","Orthodox--Total number of adherents (2010)",
                       "Church of the Brethren--Total number of adherents (2010)",
                       "Church of the Brethren--Rates of adherence per 1,000 population (2010)",
                       "Church of the Lutheran Brethren of America--Total number of congregations (2010)",
                       "Church of the Lutheran Brethren of America--Total number of adherents (2010)",
                       "Church of the Lutheran Brethren of America--Rates of adherence per 1,000 population (2010)",
                       "Church of the Lutheran Confession--Total number of congregations (2010)",
                       "Church of the Nazarene--Total number of congregations (2010)",
                       "Church of the Nazarene--Total number of adherents (2010)",
                       "Church of the Nazarene--Rates of adherence per 1,000 population (2010)",
                       "Church of the United Brethren in Christ--Total number of congregations (2010)",
                       "Orthodox--Rates of adherence per 1,000 population (2010)",
                       "Church of the United Brethren in Christ--Total number of adherents (2010)",
                       "Church of the United Brethren in Christ--Rates of adherence per 1,000 population (2010)",
                       "Churches of Christ--Total number of congregations (2010)",
                       "Churches of Christ--Total number of adherents (2010)",
                       "Churches of Christ--Rates of adherence per 1,000 population (2010)",
                       "Churches of Christ in Christian Union--Total number of congregations (2010)",
                       "Churches of God, General Conference--Total number of congregations (2010)",
                       "Churches of God, General Conference--Total number of adherents (2010)",
                       "Churches of God, General Conference--Rates of adherence per 1,000 population (2010)",
                       "Communion of Reformed Evangelical Churches--Total number of congregations (2010)",
                       "Other--Total number of congregations (2010)",
                       "Community of Christ--Total number of congregations (2010)",
                       "Community of Christ--Total number of adherents (2010)",
                       "Community of Christ--Rates of adherence per 1,000 population (2010)",
                       "Congregational Christian Churches, Additional (not part of any national CCC body)--Total number of congregations (2010)",
                       "Congregational Christian Churches, Additional (not part of any national CCC body)--Total number of adherents (2010)",
                       "Congregational Christian Churches, Additional (not part of any national CCC body)--Rates of adherence per 1,000 population (2010)",
                       "Congregational Holiness Church--Total number of congregations (2010)",
                       "Congregational Holiness Church--Total number of adherents (2010)",
                       "Congregational Holiness Church--Rates of adherence per 1,000 population (2010)",
                       "Congregational Methodist Church--Total number of congregations (2010)",
                       "All denominations/groups--Total number of adherents (2010)",
                       "Other--Total number of adherents (2010)",
                       "Congregational Methodist Church--Total number of adherents (2010)",
                       "Congregational Methodist Church--Rates of adherence per 1,000 population (2010)",
                       "Conservative Baptist Association of America--Total number of congregations (2010)",
                       "Conservative Congregational Christian Conference--Total number of congregations (2010)",
                       "Conservative Congregational Christian Conference--Total number of adherents (2010)",
                       "Conservative Congregational Christian Conference--Rates of adherence per 1,000 population (2010)",
                       "Conservative Judaism--Total number of congregations (2010)",
                       "Conservative Judaism--Total number of adherents (2010)",
                       "Conservative Judaism--Rates of adherence per 1,000 population (2010)",
                       "Conservative Lutheran Association--Total number of congregations (2010)",
                       "Other--Rates of adherence per 1,000 population (2010)",
                       "Conservative Mennonite Conference--Total number of congregations (2010)",
                       "Conservative Mennonite Conference--Total number of adherents (2010)",
                       "Conservative Mennonite Conference--Rates of adherence per 1,000 population (2010)",
                       "Conservative Yearly Meetings of Friends--Total number of congregations (2010)",
                       "Conservative Yearly Meetings of Friends--Total number of adherents (2010)",
                       "Conservative Yearly Meetings of Friends--Rates of adherence per 1,000 population (2010)",
                       "Convention of Original Free Will Baptists--Total number of congregations (2010)",
                       "Convention of Original Free Will Baptists--Total number of adherents (2010)",
                       "Convention of Original Free Will Baptists--Rates of adherence per 1,000 population (2010)",
                       "Converge Worldwide/Baptist General Conference--Total number of congregations (2010)",
                       "(Original) Church of God--Total number of congregations (2010)",
                       "Converge Worldwide/Baptist General Conference--Total number of adherents (2010)",
                       "Converge Worldwide/Baptist General Conference--Rates of adherence per 1,000 population (2010)",
                       "Coptic Orthodox Church--Total number of congregations (2010)",
                       "Coptic Orthodox Church--Total number of adherents (2010)",
                       "Coptic Orthodox Church--Rates of adherence per 1,000 population (2010)",
                       "Covenant Reformed Presbyterian Church--Total number of congregations (2010)",
                       "Cumberland Presbyterian Church--Total number of congregations (2010)",
                       "Cumberland Presbyterian Church--Total number of adherents (2010)",
                       "Cumberland Presbyterian Church--Rates of adherence per 1,000 population (2010)",
                       "Cumberland Presbyterian Church in America--Total number of congregations (2010)",
                       "African Methodist Episcopal Church--Total number of congregations (2010)",
                       "Elim Fellowship--Total number of congregations (2010)",
                       "Enterprise Baptists Association--Total number of congregations (2010)",
                       "Episcopal Church--Total number of congregations (2010)",
                       "Episcopal Church--Total number of adherents (2010)",
                       "Episcopal Church--Rates of adherence per 1,000 population (2010)",
                       "Eritrean Orthodox--Total number of congregations (2010)",
                       "Eritrean Orthodox--Total number of adherents (2010)",
                       "Eritrean Orthodox--Rates of adherence per 1,000 population (2010)",
                       "Ethiopian Orthodox--Total number of congregations (2010)",
                       "Evangelical Association of Reformed and Congregational Christian Churches--Total number of congregations (2010)",
                       "African Methodist Episcopal Church--Total number of adherents (2010)",
                       "Evangelical Church, The--Total number of congregations (2010)",
                       "Evangelical Congregational Church, The--Total number of congregations (2010)",
                       "Evangelical Congregational Church, The--Total number of adherents (2010)",
                       "Evangelical Congregational Church, The--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Covenant Church, The--Total number of congregations (2010)",
                       "Evangelical Covenant Church, The--Total number of adherents (2010)",
                       "Evangelical Covenant Church, The--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Free Church of America, The--Total number of congregations (2010)",
                       "Evangelical Free Church of America, The--Total number of adherents (2010)",
                       "Evangelical Free Church of America, The--Rates of adherence per 1,000 population (2010)",
                       "African Methodist Episcopal Church--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Friends Church International--Total number of congregations (2010)",
                       "Evangelical Friends Church International--Total number of adherents (2010)",
                       "Evangelical Friends Church International--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Lutheran Church in America--Total number of congregations (2010)",
                       "Evangelical Lutheran Church in America--Total number of adherents (2010)",
                       "Evangelical Lutheran Church in America--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Lutheran Synod--Total number of congregations (2010)",
                       "Evangelical Lutheran Synod--Total number of adherents (2010)",
                       "Evangelical Lutheran Synod--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Methodist Church--Total number of congregations (2010)",
                       "African Methodist Episcopal Zion Church--Total number of congregations (2010)",
                       "Evangelical Presbyterian Church--Total number of congregations (2010)",
                       "Evangelical Presbyterian Church--Total number of adherents (2010)",
                       "Evangelical Presbyterian Church--Rates of adherence per 1,000 population (2010)",
                       "Federation of Reformed Churches--Total number of congregations (2010)",
                       "Fellowship of Evangelical Bible Churches--Total number of congregations (2010)",
                       "Fellowship of Evangelical Bible Churches--Total number of adherents (2010)",
                       "Fellowship of Evangelical Bible Churches--Rates of adherence per 1,000 population (2010)",
                       "Fellowship of Evangelical Churches--Total number of congregations (2010)",
                       "Fellowship of Evangelical Churches--Total number of adherents (2010)",
                       "Fellowship of Evangelical Churches--Rates of adherence per 1,000 population (2010)",
                       "African Methodist Episcopal Zion Church--Total number of adherents (2010)",
                       "Foursquare Gospel, International Church of the--Total number of congregations (2010)",
                       "Foursquare Gospel, International Church of the--Total number of adherents (2010)",
                       "Foursquare Gospel, International Church of the--Rates of adherence per 1,000 population (2010)",
                       "Free Church of Scotland (Continuing)--Total number of congregations (2010)",
                       "Free Methodist Church of North America--Total number of congregations (2010)",
                       "Free Methodist Church of North America--Total number of adherents (2010)",
                       "Free Methodist Church of North America--Rates of adherence per 1,000 population (2010)",
                       "Free Presbyterian Church of North America--Total number of congregations (2010)",
                       "Free Reformed Church of North America--Total number of congregations (2010)",
                       "Friends General Conference and Friends United Meeting, dually aligned meetings--Total number of congregations (2010)",
                       "African Methodist Episcopal Zion Church--Rates of adherence per 1,000 population (2010)",
                       "Friends General Conference and Friends United Meeting, dually aligned meetings--Total number of adherents (2010)",
                       "Friends General Conference and Friends United Meeting, dually aligned meetings--Rates of adherence per 1,000 population (2010)",
                       "Friends General Conference--Total number of congregations (2010)",
                       "Friends General Conference--Total number of adherents (2010)",
                       "Friends General Conference--Rates of adherence per 1,000 population (2010)",
                       "Friends United Meeting--Total number of congregations (2010)",
                       "Friends United Meeting--Total number of adherents (2010)",
                       "Friends United Meeting--Rates of adherence per 1,000 population (2010)",
                       "Full Gospel Baptist Church Fellowship--Total number of congregations (2010)",
                       "Fundamental Baptist Fellowship--Total number of congregations (2010)",
                       "Albanian Orthodox Diocese of America--Total number of congregations (2010)",
                       "General Association of Regular Baptist Churches--Total number of congregations (2010)",
                       "Georgian Orthodox Parishes in the United States--Total number of congregations (2010)",
                       "Georgian Orthodox Parishes in the United States--Total number of adherents (2010)",
                       "Georgian Orthodox Parishes in the United States--Rates of adherence per 1,000 population (2010)",
                       "Grace Brethren Churches, Fellowship of--Total number of congregations (2010)",
                       "Grace Gospel Fellowship--Total number of congregations (2010)",
                       "Greek Orthodox Archdiocese of America--Total number of congregations (2010)",
                       "Greek Orthodox Archdiocese of America--Total number of adherents (2010)",
                       "Greek Orthodox Archdiocese of America--Rates of adherence per 1,000 population (2010)",
                       "Heritage Reformed Churches--Total number of congregations (2010)",
                       "All denominations/groups--Rates of adherence per 1,000 population (2010)",
                       "Albanian Orthodox Diocese of America--Total number of adherents (2010)",
                       "Heritage Reformed Churches--Total number of adherents (2010)",
                       "Heritage Reformed Churches--Rates of adherence per 1,000 population (2010)",
                       "Hindu, Indian-American Hindu Temple Association--Total number of congregations (2010)",
                       "Hindu, Indian-American Hindu Temple Association--Total number of adherents (2010)",
                       "Hindu, Indian-American Hindu Temple Association--Rates of adherence per 1,000 population (2010)",
                       "Hindu, Post Renaissance--Total number of congregations (2010)",
                       "Hindu, Post Renaissance--Total number of adherents (2010)",
                       "Hindu, Post Renaissance--Rates of adherence per 1,000 population (2010)",
                       "Hindu, Renaissance--Total number of congregations (2010)",
                       "Hindu, Renaissance--Total number of adherents (2010)",
                       "Albanian Orthodox Diocese of America--Rates of adherence per 1,000 population (2010)",
                       "Hindu, Renaissance--Rates of adherence per 1,000 population (2010)",
                       "Hindu, Traditional Temples--Total number of congregations (2010)",
                       "Hindu, Traditional Temples--Total number of adherents (2010)",
                       "Hindu, Traditional Temples--Rates of adherence per 1,000 population (2010)",
                       "Holy Orthodox Church in North America--Total number of congregations (2010)",
                       "Holy Orthodox Church in North America--Total number of adherents (2010)",
                       "Holy Orthodox Church in North America--Rates of adherence per 1,000 population (2010)",
                       "Hungarian Reformed Churches (Additional)--Total number of congregations (2010)",
                       "Hutterian Brethren--Total number of congregations (2010)",
                       "Independent Baptist Fellowship International--Total number of congregations (2010)",
                       "Allegheny Wesleyan Methodist Connection--Total number of congregations (2010)",
                       "Independent Fundamental Churches of America--Total number of congregations (2010)",
                       "Independent Yearly Meetings of Friends--Total number of congregations (2010)",
                       "Independent Yearly Meetings of Friends--Total number of adherents (2010)",
                       "Independent Yearly Meetings of Friends--Rates of adherence per 1,000 population (2010)",
                       "International Churches of Christ--Total number of congregations (2010)",
                       "International Churches of Christ--Total number of adherents (2010)",
                       "International Churches of Christ--Rates of adherence per 1,000 population (2010)",
                       "International Council of Community Churches--Total number of congregations (2010)",
                       "International Fellowship of Bible Churches--Total number of congregations (2010)",
                       "International Fellowship of Christian Assemblies--Total number of congregations (2010)",
                       "Allegheny Wesleyan Methodist Connection--Total number of adherents (2010)",
                       "International Pentecostal Church of Christ--Total number of congregations (2010)",
                       "International Pentecostal Church of Christ--Total number of adherents (2010)",
                       "International Pentecostal Church of Christ--Rates of adherence per 1,000 population (2010)",
                       "International Pentecostal Holiness Church--Total number of congregations (2010)",
                       "International Pentecostal Holiness Church--Total number of adherents (2010)",
                       "International Pentecostal Holiness Church--Rates of adherence per 1,000 population (2010)",
                       "Jain--Total number of congregations (2010)",
                       "Jehovah's Witnesses--Total number of congregations (2010)",
                       "Korean Presbyterian Church Abroad--Total number of congregations (2010)",
                       "Korean Presbyterian Church in America--Total number of congregations (2010)",
                       "Allegheny Wesleyan Methodist Connection--Rates of adherence per 1,000 population (2010)",
                       "Korean-American Presbyterian Church--Total number of congregations (2010)",
                       "Lutheran Church--Missouri Synod--Total number of congregations (2010)",
                       "Lutheran Church--Missouri Synod--Total number of adherents (2010)",
                       "Lutheran Church--Missouri Synod--Rates of adherence per 1,000 population (2010)",
                       "Lutheran Congregations in Mission for Christ--Total number of congregations (2010)",
                       "Lutheran Congregations in Mission for Christ--Total number of adherents (2010)",
                       "Lutheran Congregations in Mission for Christ--Rates of adherence per 1,000 population (2010)",
                       "Macedonian Orthodox Church: American Diocese--Total number of congregations (2010)",
                       "Macedonian Orthodox Church: American Diocese--Total number of adherents (2010)",
                       "Macedonian Orthodox Church: American Diocese--Rates of adherence per 1,000 population (2010)",
                       "Alliance of Baptists--Total number of congregations (2010)",
                       "Malankara Archdiocese of the Syrian Orthodox Church in North America--Total number of congregations (2010)",
                       "Malankara Archdiocese of the Syrian Orthodox Church in North America--Total number of adherents (2010)",
                       "Malankara Archdiocese of the Syrian Orthodox Church in North America--Rates of adherence per 1,000 population (2010)",
                       "Malankara Orthodox Syrian Church--Total number of congregations (2010)",
                       "Malankara Orthodox Syrian Church--Total number of adherents (2010)",
                       "Malankara Orthodox Syrian Church--Rates of adherence per 1,000 population (2010)",
                       "Maranatha Amish Mennonite--Total number of congregations (2010)",
                       "Maranatha Amish Mennonite--Total number of adherents (2010)",
                       "Maranatha Amish Mennonite--Rates of adherence per 1,000 population (2010)",
                       "Mennonite Christian Fellowship--Total number of congregations (2010)",
                       "Amana Church Society--Total number of congregations (2010)",
                       "Mennonite Christian Fellowship--Total number of adherents (2010)",
                       "Mennonite Christian Fellowship--Rates of adherence per 1,000 population (2010)",
                       "Mennonite Church USA--Total number of congregations (2010)",
                       "Mennonite Church USA--Total number of adherents (2010)",
                       "Mennonite Church USA--Rates of adherence per 1,000 population (2010)",
                       "Metropolitan Community Churches, Universal Fellowship of--Total number of congregations (2010)",
                       "Metropolitan Community Churches, Universal Fellowship of--Total number of adherents (2010)",
                       "Metropolitan Community Churches, Universal Fellowship of--Rates of adherence per 1,000 population (2010)",
                       "Midwest Beachy Amish Mennonite--Total number of congregations (2010)",
                       "Midwest Beachy Amish Mennonite--Total number of adherents (2010)",
                       "Amana Church Society--Total number of adherents (2010)",
                       "Midwest Beachy Amish Mennonite--Rates of adherence per 1,000 population (2010)",
                       "Midwest Congregational Christian Fellowship--Total number of congregations (2010)",
                       "Midwest Congregational Christian Fellowship--Total number of adherents (2010)",
                       "Midwest Congregational Christian Fellowship--Rates of adherence per 1,000 population (2010)",
                       "Missionary Church, The--Total number of congregations (2010)",
                       "Missionary Church, The--Total number of adherents (2010)",
                       "Missionary Church, The--Rates of adherence per 1,000 population (2010)",
                       "Moravian Church in America--Alaska Province--Total number of congregations (2010)",
                       "Moravian Church in America--Alaska Province--Total number of adherents (2010)",
                       "Moravian Church in America--Alaska Province--Rates of adherence per 1,000 population (2010)",
                       "Amana Church Society--Rates of adherence per 1,000 population (2010)",
                       "Moravian Church in America--Northern Province--Total number of congregations (2010)",
                       "Moravian Church in America--Northern Province--Total number of adherents (2010)",
                       "Moravian Church in America--Northern Province--Rates of adherence per 1,000 population (2010)",
                       "Moravian Church in America--Southern Province--Total number of congregations (2010)",
                       "Moravian Church in America--Southern Province--Total number of adherents (2010)",
                       "Moravian Church in America--Southern Province--Rates of adherence per 1,000 population (2010)",
                       "Muslim estimate--Total number of congregations (2010)",
                       "Muslim estimate--Total number of adherents (2010)",
                       "Muslim estimate--Rates of adherence per 1,000 population (2010)",
                       "National Association of Congregational Christian Churches--Total number of congregations (2010)",
                       "Ambassadors Amish Mennonite--Total number of congregations (2010)",
                       "National Association of Congregational Christian Churches--Total number of adherents (2010)",
                       "National Association of Congregational Christian Churches--Rates of adherence per 1,000 population (2010)",
                       "National Association of Free Will Baptists--Total number of congregations (2010)",
                       "National Association of Free Will Baptists--Total number of adherents (2010)",
                       "National Association of Free Will Baptists--Rates of adherence per 1,000 population (2010)",
                       "National Baptist Convention of America, Inc.--Total number of congregations (2010)",
                       "National Baptist Convention of America, Inc.--Total number of adherents (2010)",
                       "National Baptist Convention of America, Inc.--Rates of adherence per 1,000 population (2010)",
                       "National Baptist Convention, USA, Inc.--Total number of congregations (2010)",
                       "National Baptist Convention, USA, Inc.--Total number of adherents (2010)",
                       "Evangelical Protestant--Total number of congregations (2010)",
                       "Ambassadors Amish Mennonite--Total number of adherents (2010)",
                       "National Baptist Convention, USA, Inc.--Rates of adherence per 1,000 population (2010)",
                       "National Missionary Baptist Convention, Inc.--Total number of congregations (2010)",
                       "National Missionary Baptist Convention, Inc.--Total number of adherents (2010)",
                       "National Missionary Baptist Convention, Inc.--Rates of adherence per 1,000 population (2010)",
                       "National Spiritualist Association of Churches--Total number of congregations (2010)",
                       "New Apostolic Church of North America, National Organization of the--Total number of congregations (2010)",
                       "New Testament Association of Independent Baptist Churches--Total number of congregations (2010)",
                       "Non-denominational--Total number of congregations (2010)",
                       "Non-denominational--Total number of adherents (2010)",
                       "Non-denominational--Rates of adherence per 1,000 population (2010)",
                       "Ambassadors Amish Mennonite--Rates of adherence per 1,000 population (2010)",
                       "North American Baptist Conference--Total number of congregations (2010)",
                       "North American Baptist Conference--Total number of adherents (2010)",
                       "North American Baptist Conference--Rates of adherence per 1,000 population (2010)",
                       "North American Lutheran Church--Total number of congregations (2010)",
                       "Old Order River Brethren--Total number of congregations (2010)",
                       "Old Order River Brethren--Total number of adherents (2010)",
                       "Old Order River Brethren--Rates of adherence per 1,000 population (2010)",
                       "Open Bible Standard Churches, Inc.--Total number of congregations (2010)",
                       "Open Bible Standard Churches, Inc.--Total number of adherents (2010)",
                       "Open Bible Standard Churches, Inc.--Rates of adherence per 1,000 population (2010)",
                       "American Association of Lutheran Churches--Total number of congregations (2010)",
                       "Orthodox Church in America--Total number of congregations (2010)",
                       "Orthodox Church in America--Total number of adherents (2010)",
                       "Orthodox Church in America--Rates of adherence per 1,000 population (2010)",
                       "Orthodox Judaism--Total number of congregations (2010)",
                       "Orthodox Judaism--Total number of adherents (2010)",
                       "Orthodox Judaism--Rates of adherence per 1,000 population (2010)",
                       "Orthodox Presbyterian Church--Total number of congregations (2010)",
                       "Orthodox Presbyterian Church--Total number of adherents (2010)",
                       "Orthodox Presbyterian Church--Rates of adherence per 1,000 population (2010)",
                       "Patriarchal Parishes of the Russian Orthodox Church in the USA--Total number of congregations (2010)",
                       "American Baptist Association--Total number of congregations (2010)",
                       "Patriarchal Parishes of the Russian Orthodox Church in the USA--Total number of adherents (2010)",
                       "Patriarchal Parishes of the Russian Orthodox Church in the USA--Rates of adherence per 1,000 population (2010)",
                       "Pentecostal Church of God--Total number of congregations (2010)",
                       "Pentecostal Church of God--Total number of adherents (2010)",
                       "Pentecostal Church of God--Rates of adherence per 1,000 population (2010)",
                       "Pentecostal Fire Baptized Holiness Church--Total number of congregations (2010)",
                       "Pentecostal Free Will Baptist Church, Inc.--Total number of congregations (2010)",
                       "Pillar of Fire--Total number of congregations (2010)","Pillar of Fire--Total number of adherents (2010)",
                       "Pillar of Fire--Rates of adherence per 1,000 population (2010)",
                       "American Baptist Association--Total number of adherents (2010)",
                       "Polish National Catholic Church--Total number of congregations (2010)",
                       "Presbyterian Church (U.S.A.)--Total number of congregations (2010)",
                       "Presbyterian Church (U.S.A.)--Total number of adherents (2010)",
                       "Presbyterian Church (U.S.A.)--Rates of adherence per 1,000 population (2010)",
                       "Presbyterian Church in America--Total number of congregations (2010)",
                       "Presbyterian Church in America--Total number of adherents (2010)",
                       "Presbyterian Church in America--Rates of adherence per 1,000 population (2010)",
                       "Presbyterian Reformed Church--Total number of congregations (2010)",
                       "Primitive Baptists, Eastern District Association of--Total number of congregations (2010)",
                       "Primitive Baptists, Eastern District Association of--Total number of adherents (2010)",
                       "American Baptist Association--Rates of adherence per 1,000 population (2010)",
                       "Primitive Baptists, Eastern District Association of--Rates of adherence per 1,000 population (2010)",
                       "Primitive Methodist Church in the U.S.A.--Total number of congregations (2010)",
                       "Progressive National Baptist Convention, Inc.--Total number of congregations (2010)",
                       "Progressive National Baptist Convention, Inc.--Total number of adherents (2010)",
                       "Progressive National Baptist Convention, Inc.--Rates of adherence per 1,000 population (2010)",
                       "Protestant Reformed Churches in America--Total number of congregations (2010)",
                       "Protestant Reformed Churches in America--Total number of adherents (2010)",
                       "Protestant Reformed Churches in America--Rates of adherence per 1,000 population (2010)",
                       "Reconstructionist Judaism--Total number of congregations (2010)",
                       "Reconstructionist Judaism--Total number of adherents (2010)",
                       "American Baptist Churches in the USA--Total number of congregations (2010)",
                       "Reconstructionist Judaism--Rates of adherence per 1,000 population (2010)",
                       "Reform Judaism--Total number of congregations (2010)",
                       "Reform Judaism--Total number of adherents (2010)",
                       "Reform Judaism--Rates of adherence per 1,000 population (2010)",
                       "Reformed Baptist Churches--Total number of congregations (2010)",
                       "Reformed Church in America--Total number of congregations (2010)",
                       "Reformed Church in America--Total number of adherents (2010)",
                       "Reformed Church in America--Rates of adherence per 1,000 population (2010)",
                       "Reformed Church in the United States--Total number of congregations (2010)",
                       "Reformed Church in the United States--Total number of adherents (2010)",
                       "American Baptist Churches in the USA--Total number of adherents (2010)",
                       "Reformed Church in the United States--Rates of adherence per 1,000 population (2010)",
                       "Reformed Mennonite Church--Total number of congregations (2010)",
                       "Reformed Mennonite Church--Total number of adherents (2010)",
                       "Reformed Mennonite Church--Rates of adherence per 1,000 population (2010)",
                       "Reformed Presbyterian Church General Assembly--Total number of congregations (2010)",
                       "Reformed Presbyterian Church Hanover Presbytery--Total number of congregations (2010)",
                       "Reformed Presbyterian Church in the United States--Total number of congregations (2010)",
                       "Reformed Presbyterian Church of North America--Total number of congregations (2010)",
                       "Reformed Presbyterian Church of North America--Total number of adherents (2010)",
                       "Reformed Presbyterian Church of North America--Rates of adherence per 1,000 population (2010)",
                       "American Baptist Churches in the USA--Rates of adherence per 1,000 population (2010)",
                       "Romanian Orthodox Archdiocese in the Americas--Total number of congregations (2010)",
                       "Romanian Orthodox Archdiocese in the Americas--Total number of adherents (2010)",
                       "Romanian Orthodox Archdiocese in the Americas--Rates of adherence per 1,000 population (2010)",
                       "Russian Orthodox Church Outside of Russia--Total number of congregations (2010)",
                       "Russian Orthodox Church Outside of Russia--Total number of adherents (2010)",
                       "Russian Orthodox Church Outside of Russia--Rates of adherence per 1,000 population (2010)",
                       "Salvation Army--Total number of congregations (2010)",
                       "Salvation Army--Total number of adherents (2010)",
                       "Salvation Army--Rates of adherence per 1,000 population (2010)",
                       "Schwenkfelder Church--Total number of congregations (2010)",
                       "American Carpatho-Russian Orthodox Diocese--Total number of congregations (2010)",
                       "Schwenkfelder Church--Total number of adherents (2010)",
                       "Schwenkfelder Church--Rates of adherence per 1,000 population (2010)",
                       "Serbian Orthodox Church in North America--Total number of congregations (2010)",
                       "Serbian Orthodox Church in North America--Total number of adherents (2010)",
                       "Serbian Orthodox Church in North America--Rates of adherence per 1,000 population (2010)",
                       "Seventh Day Baptist General Conference, USA and Canada--Total number of congregations (2010)",
                       "Seventh Day Baptist General Conference, USA and Canada--Total number of adherents (2010)",
                       "Seventh Day Baptist General Conference, USA and Canada--Rates of adherence per 1,000 population (2010)",
                       "Seventh-day Adventist Church--Total number of congregations (2010)",
                       "Seventh-day Adventist Church--Total number of adherents (2010)",
                       "Evangelical Protestant--Total number of adherents (2010)",
                       "American Carpatho-Russian Orthodox Diocese--Total number of adherents (2010)",
                       "Seventh-day Adventist Church--Rates of adherence per 1,000 population (2010)",
                       "Shinto--Total number of congregations (2010)","Sikh--Total number of congregations (2010)",
                       "Southern Baptist Convention--Total number of congregations (2010)",
                       "Southern Baptist Convention--Total number of adherents (2010)",
                       "Southern Baptist Convention--Rates of adherence per 1,000 population (2010)",
                       "Southern Methodist Church--Total number of congregations (2010)",
                       "Swedenborgian Church--Total number of congregations (2010)",
                       "Syriac Orthodox Church of Antioch--Total number of congregations (2010)",
                       "Syriac Orthodox Church of Antioch--Total number of adherents (2010)",
                       "American Carpatho-Russian Orthodox Diocese--Rates of adherence per 1,000 population (2010)",
                       "Syriac Orthodox Church of Antioch--Rates of adherence per 1,000 population (2010)",
                       "Tampico Amish Mennonite--Total number of congregations (2010)",
                       "Tampico Amish Mennonite--Total number of adherents (2010)",
                       "Tampico Amish Mennonite--Rates of adherence per 1,000 population (2010)","Tao--Total number of congregations (2010)",
                       "U.S. Mennonite Brethren--Total number of congregations (2010)",
                       "U.S. Mennonite Brethren--Total number of adherents (2010)",
                       "U.S. Mennonite Brethren--Rates of adherence per 1,000 population (2010)",
                       "Ukrainian Orthodox Church of the USA--Total number of congregations (2010)",
                       "Ukrainian Orthodox Church of the USA--Total number of adherents (2010)",
                       "American Presbyterian Church--Total number of congregations (2010)",
                       "Ukrainian Orthodox Church of the USA--Rates of adherence per 1,000 population (2010)",
                       "Unaffiliated Conservative Amish Mennonite Church--Total number of congregations (2010)",
                       "Unaffiliated Conservative Amish Mennonite Church--Total number of adherents (2010)",
                       "Unaffiliated Conservative Amish Mennonite Church--Rates of adherence per 1,000 population (2010)",
                       "Unaffiliated Friends Meetings--Total number of congregations (2010)",
                       "Union of Messianic Jewish Congregations--Total number of congregations (2010)",
                       "Unitarian Universalist Association of Congregations--Total number of congregations (2010)",
                       "Unitarian Universalist Association of Congregations--Total number of adherents (2010)",
                       "Unitarian Universalist Association of Congregations--Rates of adherence per 1,000 population (2010)",
                       "United Catholic Church, Inc.--Total number of congregations (2010)",
                       "Amish groups, undifferentiated--Total number of congregations (2010)",
                       "United Catholic Church, Inc.--Total number of adherents (2010)",
                       "United Catholic Church, Inc.--Rates of adherence per 1,000 population (2010)",
                       "United Church of Christ--Total number of congregations (2010)",
                       "United Church of Christ--Total number of adherents (2010)",
                       "United Church of Christ--Rates of adherence per 1,000 population (2010)",
                       "United Holy Church of America, Inc.--Total number of congregations (2010)",
                       "United Methodist Church, The--Total number of congregations (2010)",
                       "United Methodist Church, The--Total number of adherents (2010)",
                       "United Methodist Church, The--Rates of adherence per 1,000 population (2010)",
                       "United Pentecostal Church International--Total number of congregations (2010)",
                       "Amish groups, undifferentiated--Total number of adherents (2010)",
                       "United Pentecostal Council of the Assemblies of God--Total number of congregations (2010)",
                       "United Reformed Churches in North America--Total number of congregations (2010)",
                       "United Zion Church--Total number of congregations (2010)",
                       "United Zion Church--Total number of adherents (2010)",
                       "United Zion Church--Rates of adherence per 1,000 population (2010)",
                       "Unity Churches, Association of--Total number of congregations (2010)",
                       "Unity of the Brethren--Total number of congregations (2010)",
                       "Vicariate for the Palestinian/Jordanian Orthodox Christian Communities--Total number of congregations (2010)",
                       "Vicariate for the Palestinian/Jordanian Orthodox Christian Communities--Total number of adherents (2010)",
                       "Vicariate for the Palestinian/Jordanian Orthodox Christian Communities--Rates of adherence per 1,000 population (2010)",
                       "Amish groups, undifferentiated--Rates of adherence per 1,000 population (2010)",
                       "Vineyard USA--Total number of congregations (2010)",
                       "Vineyard USA--Total number of adherents (2010)",
                       "Vineyard USA--Rates of adherence per 1,000 population (2010)",
                       "Wesleyan Church, The--Total number of congregations (2010)",
                       "Wesleyan Church, The--Total number of adherents (2010)",
                       "Wesleyan Church, The--Rates of adherence per 1,000 population (2010)",
                       "Wisconsin Evangelical Lutheran Synod--Total number of congregations (2010)",
                       "Wisconsin Evangelical Lutheran Synod--Total number of adherents (2010)",
                       "Wisconsin Evangelical Lutheran Synod--Rates of adherence per 1,000 population (2010)",
                       "Zoroastrian--Total number of congregations (2010)",
                       "Anglican Church in North America--Total number of congregations (2010)",
                       "Zoroastrian--Total number of adherents (2010)",
                       "Zoroastrian--Rates of adherence per 1,000 population (2010)","FIPS code","State code",
                       "State abbreviation","State name","County code",
                       "County name","Population in 2010",
                       "Antiochian Orthodox Christian Archdiocese of North America--Total number of congregations (2010)",
                       "Antiochian Orthodox Christian Archdiocese of North America--Total number of adherents (2010)",
                       "Antiochian Orthodox Christian Archdiocese of North America--Rates of adherence per 1,000 population (2010)",
                       "Evangelical Protestant--Rates of adherence per 1,000 population (2010)",
                       "Apostolic Christian Church of America, Inc.--Total number of congregations (2010)",
                       "Apostolic Christian Church of America, Inc.--Total number of adherents (2010)",
                       "Apostolic Christian Church of America, Inc.--Rates of adherence per 1,000 population (2010)",
                       "Apostolic Faith Mission of Portland, OR--Total number of congregations (2010)",
                       "Apostolic Faith Mission of Portland, OR--Total number of adherents (2010)",
                       "Apostolic Faith Mission of Portland, OR--Rates of adherence per 1,000 population (2010)",
                       "Apostolic Lutheran Church of America--Total number of congregations (2010)",
                       "Armenian Apostolic Church of America (Catholicosate of Cilicia)--Total number of congregations (2010)",
                       "Armenian Apostolic Church of America (Catholicosate of Cilicia)--Total number of adherents (2010)",
                       "Armenian Apostolic Church of America (Catholicosate of Cilicia)--Rates of adherence per 1,000 population (2010)",
                       "Black Protestant--Total number of congregations (2010)",
                       "Armenian Church of North America (Catholicosate of Etchmiadzin)--Total number of congregations (2010)",
                       "Armenian Church of North America (Catholicosate of Etchmiadzin)--Total number of adherents (2010)",
                       "Armenian Church of North America (Catholicosate of Etchmiadzin)--Rates of adherence per 1,000 population (2010)",
                       "Armenian Evangelical Churches (Additional)--Total number of congregations (2010)",
                       "Assemblies of God--Total number of congregations (2010)",
                       "Assemblies of God--Total number of adherents (2010)",
                       "Assemblies of God--Rates of adherence per 1,000 population (2010)",
                       "Assemblies of God International Fellowship--Total number of congregations (2010)",
                       "Associate Reformed Presbyterian Church--Total number of congregations (2010)",
                       "Associate Reformed Presbyterian Church--Total number of adherents (2010)",
                       "Black Protestant--Total number of adherents (2010)",
                       "Associate Reformed Presbyterian Church--Rates of adherence per 1,000 population (2010)",
                       "Association of Free Lutheran Congregations--Total number of congregations (2010)",
                       "Association of Messianic Congregations--Total number of congregations (2010)",
                       "Association of Reformed Baptist Churches of America--Total number of congregations (2010)",
                       "Baha'i--Total number of congregations (2010)",
                       "Baha'i--Total number of adherents (2010)",
                       "Baha'i--Rates of adherence per 1,000 population (2010)",
                       "Beachy Amish Mennonite Churches--Total number of congregations (2010)",
                       "Beachy Amish Mennonite Churches--Total number of adherents (2010)",
                       "Beachy Amish Mennonite Churches--Rates of adherence per 1,000 population (2010)",
                       "Black Protestant--Rates of adherence per 1,000 population (2010)",
                       "Berea Amish Mennonite--Total number of congregations (2010)",
                       "Berea Amish Mennonite--Total number of adherents (2010)",
                       "Berea Amish Mennonite--Rates of adherence per 1,000 population (2010)",
                       "Bible Fellowship Church--Total number of congregations (2010)",
                       "Bible Fellowship Church--Total number of adherents (2010)",
                       "Bible Fellowship Church--Rates of adherence per 1,000 population (2010)",
                       "Bible Presbyterian Church (General Synod)--Total number of congregations (2010)",
                       "Brethren Church, The (Ashland, Ohio)--Total number of congregations (2010)",
                       "Brethren Church, The (Ashland, Ohio)--Total number of adherents (2010)",
                       "Brethren Church, The (Ashland, Ohio)--Rates of adherence per 1,000 population (2010)")
)

p_load(readstata13)
dat <- read.dta13("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/U.S. Religion Census Religious Congregations and Membership Study, 2010 (County File).DTA")

#562) FIPS	FIPS code
#563) STCODE	State code
#564) STABBR	State abbreviation
#565) STNAME	State name
#566) CNTYCODE	County code
#567) CNTYNAME	County name
dat_long <- dat %>% pivot_longer(-c(fips,stcode,stabbr,stname,cntycode,cntyname))
dat_long_clean <- dat_long %>% mutate(name=name %>% tolower() %>% trimws()) %>% 
  left_join(thearda_codebook %>% dplyr::select(name=variable,description) %>% mutate(name=name %>% tolower()  %>% str_replace('[0-9]*\\) ','') %>% trimws()  )  )

rhs_thearda <- dat_long_clean %>% dplyr::select(fips, name, description, value)  %>%
              mutate(dataset='therda') %>%
              mutate(description=description %>% str_replace("rates of adherence per 1,000 population (2010)","per capita")  ) %>%
              mutate(variable=paste0("therda_",description %>% tolower())) %>% 
              mutate(description=paste0("religion ",description %>% tolower())) %>%
              filter(!is.na(value))

rhs_thearda  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_thearda.parquet"))

rhs_thearda %>% mutate(fips_variable=paste0(fips,variable)) %>% filter(duplicated(fips_variable)) #no dupes here yet so it's getting introduced lower

```
## Climate Change

```{r}

yale_df <- data.frame(
      stringsAsFactors = FALSE,
    name = c("GeoType","GEOID",
                           "GeoName","TotalPop","happening","happeningOppose",
                           "human","humanOppose","consensus","consensusOppose",
                           "affectweather","affectweatherOppose","worried",
                           "worriedOppose","harmplants","harmplantsOppose",
                           "futuregen","futuregenOppose","devharm",
                           "devharmOppose","harmUS","harmUSOppose","personal",
                           "personalOppose","timing","timingOppose","fundrenewables",
                           "fundrenewablesOppose","regulate","regulateOppose",
                           "CO2limits","CO2limitsOppose","reducetax",
                           "reducetaxOppose","supportRPS","supportRPSOppose",
                           "rebates","rebatesOppose","drillANWR","drillANWROppose",
                           "drilloffshore","drilloffshoreOppose","teachGW",
                           "teachGWOppose","corporations","corporationsOppose",
                           "president","presidentOppose","congress",
                           "congressOppose","governor","governorOppose",
                           "localofficials","localofficialsOppose","citizens",
                           "citizensOppose","prienv","prienvOppose","discuss",
                           "discussOppose","mediaweekly","mediaweeklyOppose","gwvoteimp",
                           "gwvoteimpOppose","priority","priorityOppose"),
  description = c("Geographic level",
                           "Geographic abbreviation","Geographic name",
                           "Total population",
                           "Estimated percentage who think that global warming is happening",
                           "Estimated percentage who do not think that global warming is happening",
                           "Estimated percentage who think that global warming is caused mostly by human activities",
                           "Estimated percentage who think that global warming is caused mostly by natural changes in the environment",
                           "Estimated percentage who believe that most scientists think global warming is happening",
                           "Estimated percentage who believe there is a lot of disagreement among scientists about whether or not global warming is happening",
                           "Estimated percentage who somewhat/strongly agree that global warming is affecting the weather in the United States",
                           "Estimated percentage who somewhat/strongly disagree that global warming is affecting the weather in the United States",
                           "Estimated percentage who are somewhat/very worried about global warming",
                           "Estimated percentage who are not very/not at all worried about global warming",
                           "Estimated percentage who think global warming will harm plants and animal species a moderate amount/a great deal",
                           "Estimated percentage who think global warming will harm plants and animal species not at all/only a little",
                           "Estimated percentage who think global warming will harm future generations a moderate amount/a great deal",
                           "Estimated percentage who think global warming will harm future generations not at all/only a little",
                           "Estimated percentage who think global warming will harm people in developing countries a moderate amount/a great deal",
                           "Estimated percentage who think global warming will harm people in developing countries not at all/only a little",
                           "Estimated percentage who think global warming will harm people in the US a moderate amount/a great deal",
                           "Estimated percentage who think global warming will harm people in the US not at all/only a little",
                           "Estimated percentage who think global warming will harm them personally a moderate amount/a great deal",
                           "Estimated percentage who think global warming will harm them personally not at all/only a little",
                           "Estimated percentage who think global warming will start to harm people in the United now/within 10 years",
                           "Estimated percentage who think global warming will start to harm people in the United in 25 years or longer, or never",
                           "Estimated percentage who somewhat/strongly support funding research into renewable energy sources",
                           "Estimated percentage who somewhat/strongly oppose funding research into renewable energy sources",
                           "Estimated percentage who somewhat/strongly support regulating CO2 as a pollutant",
                           "Estimated percentage who somewhat/strongly oppose regulating CO2 as a pollutant",
                           "Estimated percentage who somewhat/strongly support setting strict limits on existing coal-fire power plants",
                           "Estimated percentage who somewhat/strongly oppose setting strict limits on existing coal-fire power plants",
                           "Estimated percentage who somewhat/strongly support requiring fossil fuel companies to pay a carbon tax and use the money to reduce other taxes (such as income tax) by an equal amount",
                           "Estimated percentage who somewhat/strongly oppose requiring fossil fuel companies to pay a carbon tax and use the money to reduce other taxes (such as income tax) by an equal amount",
                           "Estimated percentage who somewhat/strongly support requiring utilities to produce 20% electricity from renewable sources",
                           "Estimated percentage who somewhat/strongly oppose requiring utilities to produce 20% electricity from renewable sources",
                           "Estimated percentage who somewhat/strongly support providing tax rebates for people who purchase energy-efficient vehicles or solar panels",
                           "Estimated percentage who somewhat/strongly oppose providing tax rebates for people who purchase energy-efficient vehicles or solar panels",
                           "Estimated percentage who somewhat/strongly support drilling for oil in the Arctic National Wildlife Refuge",
                           "Estimated percentage who somewhat/strongly oppose drilling for oil in the Arctic National Wildlife Refuge",
                           "Estimated percentage who somewhat/strongly support expanding offshore drilling for oil and natural gas off the U.S. coast",
                           "Estimated percentage who somewhat/strongly oppose expanding offshore drilling for oil and natural gas off the U.S. coast",
                           "Estimated percentage who somewhat/strongly agree that schools should teach about the causes, consequences, and potential solutions to global warming",
                           "Estimated percentage who somewhat/strongly disagree that schools should teach about the causes, consequences, and potential solutions to global warming",
                           "Estimated percentage who think corporations and industy should be doing more/much more to address global warming",
                           "Estimated percentage who think corporations and industy should be doing less/much less to address global warming",
                           "Estimated percentage who think the President themselves should be doing more/much more to address global warming",
                           "Estimated percentage who think the President themselves should be doing less/much less to address global warming",
                           "Estimated percentage who think Congress should be doing more/much more to address global warming",
                           "Estimated percentage who think Congress should be doing less/much less to address global warming",
                           "Estimated percentage who think their governor should be doing more/much more to address global warming",
                           "Estimated percentage who think their governor should be doing less/much less to address global warming",
                           "Estimated percentage who think their local officials should be doing more/much more to address global warming",
                           "Estimated percentage who think their local officials should be doing less/much less to address global warming",
                           "Estimated percentage who think citizens themselves should be doing more/much more to address global warming",
                           "Estimated percentage who think citizens themselves should be doing less/much less to address global warming",
                           "Estimated percentage who think protecting the environment is more important than economic growth, even if it reduces economic growth",
                           "Estimated percentage who think economic growth is more important than protecting the environment, even if it leads to environmental problems",
                           "Estimated percentage who discuss global warming occassionally or often with friends and family",
                           "Estimated percentage who discuss global warming rarely or never with friends and family",
                           "Estimated percentage who hear about global warming in the media at least weekly",
                           "Estimated percentage who hear about global warming in the media several times a year or less often",
                           "Estimated percentage who say global warming should be a high priority for the next president and Congress",
                           "Estimated percentage who do not say global warming should be a high priority for the next president and Congress",
                           "Estimated percentage who say a candidate's views on GW are important to their vote",
                           "Estimated percentage who do not say a candidate's views on GW are important to their vote")
)

YCOM_2020_Data <- fread("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_in/YCOM_2020_Data.csv")

rhs_globalwarming <- YCOM_2020_Data %>%
                    dplyr::select(-GeoType, -GeoName, - TotalPop) %>%
                    dplyr::rename(fips=GEOID) %>%
                    pivot_longer(-fips) %>%
                    left_join(yale_df) %>%
                    dplyr::select(fips, name, description, value)  %>%
                    mutate(dataset='yale') %>%
                    mutate(description=description %>% str_replace("Estimated percentage who ","percent who self report ") %>% str_replace(" GW "," global warming")  ) %>%
                    mutate(variable=paste0("yale_",description %>% tolower())) %>%
                    #mutate(description=paste0("global warming ",description %>% tolower())) %>%
                    filter(!is.na(value)) %>% 
                    filter(!duplicated(paste(fips,variable))) #There's a duplicated fips
rhs_globalwarming %>% dplyr::select(fips,variable) %>% count(fips,variable) %>% filter(n>1) #%>% View()

rhs_globalwarming  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_globalwarming.parquet")) 

```


# Appendix 2: County Level Vaccine Uptake

### CDC

```{r}

#If it's not today then don't run 

if(fromscratch){
  dl <- fread("https://data.cdc.gov/api/views/8xkx-amqh/rows.csv?accessType=DOWNLOAD") 
  lhs_cdc <-  dl %>% 
       clean_names() %>%
       mutate(date=date %>% as.character() %>% lubridate::mdy()) %>% 
       filter(date==max(date)) %>% #Update to whichever date we pull the Democratandchronicle data #this fails because they may not have updated it to day when yo urun this
       mutate(fips=fips %>% as.numeric()) %>%
       mutate(series_complete_18plus_pop_pct=series_complete_18plus_pop_pct/100) %>%
       mutate(series_complete_pop_pct=series_complete_pop_pct/100) %>%
       mutate(series_complete_18plus_pop_pct=ifelse(series_complete_18plus_pop_pct %in% c(0,1), NA, series_complete_18plus_pop_pct )) %>%
       mutate(series_complete_pop_pct=ifelse(series_complete_pop_pct %in% c(0,1), NA, series_complete_pop_pct )) #%>%
    
       #filter(series_complete_18plus_pop_pct!=0 & series_complete_18plus_pop_pct!=1) %>%
       #dplyr::select(recip_state, recip_county, fips,series_complete_18plus_pop_pct, series_complete_pop_pct) %>%
       #mutate(retrieved=Sys.Date())
  dim(lhs_cdc)
  saveRDS(lhs_cdc, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/cdc_vaccine_rates.Rds" )
}

lhs_cdc <- readRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/cdc_vaccine_rates.Rds" ) %>%
  dplyr::select(recip_state, recip_county, fips, people_partial_cdc=administered_dose1_recip, people_complete_cdc=series_complete_yes  ) 

```

The distribution of up Uptake in the country is still abysmal, with the
median county at only 41%, and the 3rd quartile barely at 50%.

```{r, results=T, eval=F}
lhs_cdc %>% pull(people_partial_cdc) %>% summary()
```

90% of counties land between 12% and 63%. The measurement task therefore
isn't so much to explain high vaccine uptake from low, but rather to
identify stragglers with low uptake form the central mass.

```{r, eval=F}
lhs_cdc %>% pull(people_partial_cdc) %>% quantile(prob=seq(0,1,.01), na.rm=T)
```

```{r, fig.width = 6, fig.height = 4, eval=F}
lhs_cdc %>% ggplot(aes(x=people_partial_cdc)) + geom_histogram(bins=100)
```

So who are the stragglers? Here's a map showing the rates in the data.
Texas is missing entirely for reporting issues. A few very rural
counties are missing as well. The stragglers appear to be concentrated
in three states, George, Virginia, and West Virginia and more
sporadically across the midwest. Bounding effects that show state are
evidence of geogrpahic and administrative auto-correlation, from
administration, reporting, or both.

```{r, eval=F}

#devtools::install_github("UrbanInstitute/urbnmapr")
library(tidyverse)
library(urbnmapr)

map_data <- left_join(lhs_cdc, urbnmapr::counties %>% mutate(county_fips=county_fips %>% as.numeric() ), by = c("fips"="county_fips") )
p <- map_data %>%
  mutate(people_partial_cdc=ifelse(people_partial_cdc==0, NA, people_partial_cdc)) %>% #ignore 0 as missing
  ggplot(aes(long, lat, group = group, fill = people_partial_cdc)) +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = "Partialy Vaccinated")

```

```{r, fig.width = 12, fig.height = 8, results=T, eval=F}
p
```

Here is Uptake in tabular format that you can browse in its entirety.
Sorted by least Uptake, the top 100 offenders are all VA, WV, GA and one
county from MA. The values aren't just low but near 0, which should set
off alarm bells that there might still be measurement processes we
haven't accounted for. In fact, if we look at the [New York Times
Vaccine
tracker](https://www.nytimes.com/interactive/2020/us/covid-19-vaccine-doses.html),
we find that they leave out precisely those three states as
"insufficient data." The [Washington Post's vaccine
tracker](https://www.washingtonpost.com/graphics/2020/health/covid-vaccine-states-distribution-doses/)
excludes another three states, New Mexico, Colorado, and South Dakota
because less than 85% of vaccination records include a person's county
of residence.

```{r, results='asis'}

p_load(DT); #install.packages('DT')
DT::datatable(lhs_cdc %>% arrange(people_partial_cdc), rownames = FALSE)

```

### USA Today Network

The USA Today Network produces databases and visualizations for
affiliate, including the [COVID-19 Vaccine
Tracker](https://data.democratandchronicle.com/covid-19-vaccine-tracker/).
The details of the database are obscure but it pulls CDC data and fills
in missing or broken states with data directly from state health
agencies. We can pull their numbers for each county and compare them to
the CDC counts. Their data cover 3,222 counties.

```{r}

p_load(rvest)
if(fromscratch){
  
  link <- "https://data.democratandchronicle.com/covid-19-vaccine-tracker/"
  driver <- read_html(link)  
  state_links <- driver %>%
  html_nodes("table") %>%
  html_nodes("td") %>% 
  html_nodes("a") %>% 
  html_attr("href")

  df_list <- list()
  for(state in state_links[2:length(state_links)]){
    print(state)
    county_table <- NULL
    link=paste0("https://data.democratandchronicle.com/",state)
    driver <- read_html(link)
    county_links <-   driver %>%
            html_nodes("table") %>%
            html_nodes("td") %>% 
            html_nodes("a") %>% 
            html_attr("href")
    allTables <- html_nodes(driver, css = "table")
    county_table <- html_table(allTables)[[3]] %>% janitor::clean_names()
    county_table$urls <- county_links
    county_table$state <- state
    df_list[[state]] <- county_table
    df_list[[state]]$retrieved <- Sys.Date()
  }   

  saveRDS(df_list, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/democratandchronicle_vaccine_rates.Rds")
}

df_list <-  readRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/democratandchronicle_vaccine_rates.Rds")

items <- names(df_list)
for(item in items){
  
  M <- df_list[[item]]
  M$population_numeric <- M$population %>% str_replace(",","") %>% as.numeric()
  M$people_fully_vaccinated_commas <- M$people_fully_vaccinated %>%   str_count(pattern = ",")
  M$percent_vaccinated <- M$people_fully_vaccinated %>%  str_sub(-6,-2) %>% as.numeric()
  M$percent_vaccinated2 <- M$people_fully_vaccinated %>% str_replace(".*,[0-9][0-9][0-9]","") 
  condition <- nchar(M$percent_vaccinated2)==9 #36953.56% #If it's 9 long then we know it's 3 digits of population and 6 digits of percent because neither can be longer without introducing a comma
  M$percent_vaccinated2[condition] <- M$people_fully_vaccinated[condition] %>% str_replace("^[0-9][0-9][0-9]","")
  #"49330.02%"
  M$percent_vaccinated2_nchar <- nchar(M$percent_vaccinated2)
  
  condition <- nchar(M$percent_vaccinated2)==7 #459.91% remove the first two, if it were a double digit percentage the count would have to be bigger
  M$percent_vaccinated2[condition] <- M$people_fully_vaccinated[condition] %>% str_replace("^[0-9][0-9]","")

  condition <- nchar(M$percent_vaccinated2)==8 #I think this miscodes 1 county, I'm ok with it
  M$percent_vaccinated2[condition] <- M$people_fully_vaccinated[condition] %>% str_replace("^[0-9][0-9][0-9]","")
  
  M$percent_vaccinated2 <- M$percent_vaccinated2 %>% str_replace("%","") %>% as.numeric()
  M$people_fully_vaccinated_numeric <- M$people_fully_vaccinated %>%  str_sub(-100,-M$percent_vaccinated2_nchar-1) %>% str_replace_all(",","") %>% as.numeric()
  M$fips <- M$urls %>%  str_sub(-6,-2)
  df_list[[item]] <- M %>% dplyr::select(fips, people_complete_usatoday=people_fully_vaccinated_numeric, retrieved)
}
lhs_usatodaynetwork <- bind_rows(df_list)
  
 

```

### CHHS

California's numbers

```{r}
#uhg doesn't have fips
chhs <- fread("https://data.chhs.ca.gov/dataset/e283ee5a-cf18-4f20-a92c-ee94a2866ccd/resource/130d7ba2-b6eb-438d-a412-741bde207e1c/download/covid19vaccinesbycounty.csv")
dim(chhs)

#administered_date
#total_partially_vaccinated
#cumulative_at_least_one_dose

ca_today <- chhs %>% dplyr::filter(administered_date=="2021-06-24")

```

### vaccinetracking.us

<http://www.vaccinetracking.us/>
<https://raw.githubusercontent.com/bansallab/vaccinetracking/main/vacc_data/data_master_county.csv>

"What are some limitations of the data?
1) The data collation process described above is a process in flux caused by the unpredictable changes in data access, data definitions and data formats provided by the CDC and states. 2) Many states report vaccinated doses administered which have no county residence information (due to missing information about residents or because the vaccinated individual does not live in that state). These vaccinations are not counted in our county-level vaccination counts. We find that these vaccinations do not make up more than 10% of any states total vaccination counts. 3) The county-level vaccination counts reported by the CDC do not include county residents vaccinated by Veterans Affairs, the Department of Defense, the Indian Health Service, and the Bureau of Prisons. Some states do include these vaccinations in their provided data, others do not. We are working to better disentangle and integrate these data."


```{r}

if(fromscratch){
vaccinetracking <- fread("https://raw.githubusercontent.com/bansallab/vaccinetracking/main/vacc_data/data_master_county.csv")
dim(vaccinetracking)

table(vaccinetracking$CASE_TYPE)

vaccinetracking1 <- vaccinetracking %>% 
  clean_names() %>%
  #mutate(date=date %>% as.Date()) %>%
  #filter(date==max(date)) %>% 
  filter(case_type=="Complete") %>%
  mutate(people_complete_vaccinetracking=cases)

vaccinetracking2 <- vaccinetracking %>% 
                    clean_names() %>%
                    #mutate(date=date %>% as.Date()) %>%
                    #filter(date==max(date)) %>% 
                    filter(case_type %in% "Partial") %>%
                    mutate(people_partial_vaccinetracking=cases)


vaccinetracking1 %>% dplyr::select(fips=county, people_complete_vaccinetracking) %>%
  full_join(vaccinetracking2 %>% dplyr::select(fips=county, people_partial_vaccinetracking))  %>% 
              saveRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vaccinetracking.Rds" )

}
lhs_vaccinetracking <- readRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data/vaccinetracking.Rds" )


```

### CovidActNow

Some states don't release county level information leading to under
reporting. Being next to a large county might also further distort
because the vaccinations are attributed to that bigger county.

```{r}

if(fromscratch){
  covidactnow <- fread("https://api.covidactnow.org/v2/counties.timeseries.csv?apiKey=dac8cf4330284a3baa80cff5c9720176")
  saveRDS(covidactnow, "/mnt/8tb_a/rwd_github_private/NESSrdf/data_temp/covidactnow.Rds")
}
covidactnow <- readRDS( "/mnt/8tb_a/rwd_github_private/NESSrdf/data_temp/covidactnow.Rds")

lhs_covidactnow <- covidactnow %>% dplyr::select(date, fips, people_partial_covidactnow=actuals.vaccinationsInitiated, people_complete_covidactnow=actuals.vaccinationsCompleted)

```


### Compare and Synthesize

Compared to the Democrat and Chronicle data, the CDC systematically
under reports vaccinations in VA, GA, NC, etc. The CDC data have higher
numbers for PR as well as a few other counties. The Democrat and
Chronicle data also have all of Texas.


```{r lhs_summary_statistics}

rhs_census2020 <- arrow::read_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020.parquet"))

population_14plus <- rhs_census2020  %>% filter(variable=="census2020_population_above_14 years old,_total population") %>% dplyr::select(fips, population_14plus=value) %>% mutate(fips=as.numeric(fips))
rhs_census_2020  <- arrow::read_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020_actual.parquet"))

#Wow for bexar it's 16% off
#####Ahhhhhhh 
#This breakdown here mentions that VA and dod data are included in the city's numbers but not in what the cdc reports
#https://cosacovid-cosagis.hub.arcgis.com/datasets/CoSAGIS::vaccinations-countystats-public/explore

#Vaccinations by facility
#https://www.accesstocare.va.gov/Healthcare/COVID19NationalSummary
lhs <- NULL
lhs <- lhs_usatodaynetwork  %>% 
       dplyr::select(fips, people_complete_usatoday )  %>% #,  retrieved_usatoday = retrieved
       mutate(fips=as.numeric(fips)) %>% 
       mutate(fips_state= floor(fips/1000) ) %>% 
       filter(!is.na(fips) ) %>% distinct() %>%
       full_join(lhs_cdc %>% filter(!is.na(fips)) %>% distinct()  ) %>% 
       full_join(lhs_vaccinetracking %>% filter(!is.na(fips)) %>% distinct() ) %>% 
       full_join(lhs_covidactnow %>% filter(!is.na(fips)) %>% distinct()   %>% dplyr::select(-date) %>% group_by(fips) %>% summarise_all(max,na.rm=T) ) %>% 
       full_join(vacovid19summary_geolocated_clean %>% filter(!is.na(fips)  ) %>% janitor::clean_names()  %>% dplyr::select(fips,people_partial_va, people_complete_va) %>% distinct()  )  %>%
  
       left_join(population_14plus %>% distinct() ) %>%
       left_join(rhs_census_2020 %>% filter(variable=="pop") %>% dplyr::select(fips,population_18plus=value) %>% mutate(fips=as.numeric(fips)) %>% distinct() ) %>%
  
       mutate_if(is.numeric, list(~na_if(., Inf))) %>%
       mutate_if(is.numeric, list(~na_if(., -Inf))) %>%
       #writing this again from scratch
  
       mutate(cdc_invalid              = is.na(people_partial_cdc) | is.na(people_complete_cdc) |
                                         people_partial_cdc<people_complete_cdc | people_partial_cdc>population_14plus | people_complete_cdc>population_14plus | people_partial_cdc<=0 | people_complete_cdc<=0 ) %>%
       mutate(vaccinetracking_invalid  = is.na(people_partial_vaccinetracking) | is.na(people_complete_vaccinetracking) |
                                       people_partial_vaccinetracking<people_complete_vaccinetracking | people_partial_vaccinetracking>population_14plus | 
                                       people_complete_vaccinetracking>population_14plus | people_partial_vaccinetracking<=0 | people_complete_vaccinetracking<=0) %>%
  
       mutate(covidactnow_invalid      = is.na(people_partial_covidactnow) | is.na(people_complete_covidactnow) |
                                        people_partial_covidactnow<people_complete_covidactnow | people_partial_covidactnow>population_14plus | people_complete_covidactnow>population_14plus | people_partial_covidactnow<=0 | people_complete_covidactnow<=0) %>%
  
       mutate(usatoday_invalid         = is.na(people_complete_usatoday) | 
                                        people_complete_usatoday>population_14plus | people_complete_usatoday<=0 ) %>%
  
       group_by(fips) %>%
         
        mutate(people_partial_max = max(  people_partial_vaccinetracking[!vaccinetracking_invalid] , people_partial_covidactnow[!covidactnow_invalid], na.rm=T)) %>% #people_partial_cdc[!cdc_invalid]
        mutate(people_complete_max = max(  people_complete_vaccinetracking[!vaccinetracking_invalid] , people_complete_covidactnow[!covidactnow_invalid],  people_complete_usatoday[!usatoday_invalid], na.rm=T)) %>% #people_complete_cdc[!cdc_invalid]

        mutate(people_partial_mean = max(  people_partial_vaccinetracking[!vaccinetracking_invalid] , people_partial_covidactnow[!covidactnow_invalid],  na.rm=T)) %>% #people_partial_cdc[!cdc_invalid]
        mutate(people_complete_mean = max(  people_complete_vaccinetracking[!vaccinetracking_invalid] , people_complete_covidactnow[!covidactnow_invalid], people_complete_usatoday[!usatoday_invalid], na.rm=T)) %>% # people_complete_cdc[!cdc_invalid]
                  
       ungroup() %>%
       filter(!is.na(fips)) %>%
       filter(is.finite(people_partial_max) & is.finite(people_complete_max)) %>%
        mutate(people_partial_mean_perc14plus=people_partial_mean / population_14plus) %>%
        mutate(people_complete_mean_perc14plus=people_complete_mean / population_14plus)  %>%
        mutate(people_partial_mean_perc18plus=people_partial_mean / population_18plus) %>%
        mutate(people_complete_mean_perc18plus=people_complete_mean / population_18plus) 
  

lhs   %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/lhs/lhs.parquet"))


lhs <-   arrow::read_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/lhs/lhs.parquet"))

lhs %>% dplyr::select(people_partial_va, people_complete_va, people_partial_max, people_complete_max) %>% summarize_if(is.numeric, sum, na.rm=T)
  


#Just to prove a point, I'm going to include the raw uncleaned measures including some I didn't use as potential right hand sides and make sure they have clear descriptions and get their own cluster
#This should be the first used and set the lower bound on how well a model could possibly perform
warning_lhs_as_righthandside <- lhs %>% 
                        dplyr::select(fips, people_partial_cdc, people_partial_vaccinetracking, people_partial_covidactnow, people_complete_usatoday, population_18plus) %>%
                        mutate(WARNING_DV_ON_RHS_people_partial_cdc_18plus=people_partial_cdc/population_18plus) %>%
                        mutate(WARNING_DV_ON_RHS_people_partial_vaccinetracking_18plus=people_partial_vaccinetracking/population_18plus) %>%
                        mutate(WARNING_DV_ON_RHS_people_partial_covidactnow_18plus=people_partial_covidactnow/population_18plus) %>%
                        mutate(WARNING_DV_ON_RHS_people_complete_usatoday_18plus=people_complete_usatoday/population_18plus) %>%
                        dplyr::select(fips,WARNING_DV_ON_RHS_people_partial_cdc_18plus,WARNING_DV_ON_RHS_people_partial_vaccinetracking_18plus,
                                      WARNING_DV_ON_RHS_people_partial_covidactnow_18plus,WARNING_DV_ON_RHS_people_complete_usatoday_18plus) %>%
                        pivot_longer(-fips) %>%
                        rename(variable=name) %>% 
                        mutate(description=variable) %>%
                        mutate(dataset="WARNING_LHS_on_the_RHS")
  
warning_lhs_as_righthandside  %>% rex_clean() %>% arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/warning_lhs_as_righthandside.parquet")) 


lhs_state <- ( temp1 %>% filter(fips_missing==0) %>% 
                           dplyr::select(fips_state,people_partial_cdc_countyonly=people_partial_cdc, people_complete_cdc_countyonly=people_complete_cdc) %>% filter(!is.na(fips_state)) ) %>%
  
              full_join( temp1 %>% filter(fips_missing==1) %>% 
                           dplyr::select(fips_state,people_partial_cdc_stateonly=people_partial_cdc , people_complete_cdc_stateonly=people_complete_cdc) %>% filter(!is.na(fips_state))  ) %>%
  
              full_join(jhu %>% clean_names() %>% dplyr::select(fips_state=fips, people_complete_jhu =  people_fully_vaccinated , people_partial_jhu=people_partially_vaccinated) %>% filter(!is.na(fips_state)) ) %>%
              full_join(lhs %>% dplyr::select(recip_state, fips_state, people_complete_usatoday, people_complete_vaccinetracking, people_partial_vaccinetracking, people_partial_covidactnow, people_complete_covidactnow, people_partial_va, people_complete_va) %>%
                          group_by(recip_state, fips_state) %>% summarize_if(is.numeric, sum, na.rm=T) %>% filter(!is.na(fips_state))
                        ) %>%
  
              mutate( people_partial_cdc = people_partial_cdc_countyonly + people_partial_cdc_stateonly) %>%
              mutate( people_complete_cdc = people_complete_cdc_countyonly + people_complete_cdc_stateonly) %>%
  
              mutate( people_partial_cdc_stateonlyperc = people_partial_cdc_stateonly / people_partial_cdc) %>%
              mutate( people_complete_cdc_stateonlyperc = people_complete_cdc_stateonly / people_complete_cdc)  %>%
              group_by(fips_state) %>%
                mutate(people_partial_max = max(people_partial_jhu,  people_partial_vaccinetracking , people_partial_covidactnow, people_partial_cdc, na.rm=T)) %>%
                mutate(people_complete_max = max(people_complete_jhu,  people_complete_usatoday, people_complete_vaccinetracking , people_complete_covidactnow, people_complete_cdc, na.rm=T)) %>%
  
                mutate(people_partial_max_attributable_to_county = max(  people_partial_vaccinetracking , people_partial_covidactnow, people_partial_cdc_countyonly, na.rm=T)) %>% #excluding jhu because that's not county
                mutate(people_complete_max_attributable_to_county = max(  people_complete_vaccinetracking , people_complete_covidactnow, people_complete_cdc_countyonly, na.rm=T)) %>% #excluding jhu because that's not county

                mutate(people_partial_perc_attributable_to_county = people_partial_max_attributable_to_county / people_partial_max ) %>%
                mutate(people_complete_perc_attributable_to_county = people_complete_max_attributable_to_county / people_complete_max) %>%

              ungroup() 

lhs_state  %>% 
  #rex_clean() %>%
  arrow::write_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/lhs/lhs_state.parquet"))


```


# Combine RHS


```{r}


#filenames <- list.files("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/", full.names=TRUE)  
#cols <- lapply(filenames, FUN=function(x){ x %>%  arrow::read_parquet() %>% colnames() } ) # even this is not great

#rhs_long <- arrow::open_dataset(sources="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/") #%>% collect()
rhs_long <- spark_read_parquet(sc, path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/" ,memory=F) 
#rhs_long %>% head()

#dim(rhs_long) #263,862,163
#rhs_long %>% dplyr::select(dataset) %>% pull(dataset) %>% table(useNA="always")

#fips_variable <- rhs_long %>% dplyr::select(fips, variable) %>% collect() #%>% as.data.table()
#dim(fips_variable) #774,081,279
#dim(unique(fips_variable)) #306726494

#fips_variable  %>% filter(fips==11001) %>% mutate(dupe=duplicated(variable)) %>% View()

#fips_variable_value <- rhs_long %>% dplyr::select(fips, variable, dataset, value) %>% collect() #%>% as.data.table()
#dim(fips_variable_value) #774,081,279
#fips_variable_value_1001 <- fips_variable_value %>% filter(fips==1001) %>% mutate(dupe=duplicated(variable))

#table(is.finite(fips_variable$variable)) #It's 387 million so things are getting pretty wild at this point
#vars <- fips_variable$variable %>% unique() 
#length(vars) #62,019

#Create a percapita version
#rhs_long_population <- rhs_long %>% dplyr::select(fips, variable, value)  %>% filter(variable=="census2020_population_total,_total population") #%>% collect() 

rhs_long_population  <- arrow::read_parquet(glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/rhs_census2020_actual.parquet")) %>% 
                        filter(variable=="pop") %>% dplyr::select(fips,population=value) %>% mutate(fips=as.numeric(fips)) %>% distinct()


rhs_long_counts <- rhs_long %>% dplyr::select(fips, variable, description, dataset, value) %>% filter(!variable %rlike% "_perc|percap|percapita*|per capita|percent") #%>% collect() 

rhs_long_counts %>% spark_write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_long_counts/", mode="overwrite") #
rhs_long_counts <- spark_read_parquet(sc, path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_long_counts/" ,memory=F)


rhs_long_percap <- rhs_long_counts %>% 
                   left_join(rhs_long_population %>% dplyr::select(fips, population=population) , copy=T) %>% #We're normalizing by the 2020 measure 18+ population now
                   mutate(value=value/population) %>%
                   mutate(variable=paste0(variable,"_percapita"))  %>% 
                   mutate(description=paste0("per capita ", description)) 

sdf_bind_rows(rhs_long,rhs_long_percap) %>% spark_write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined/", mode="overwrite")

#rhs_long_percap  %>% rex_clean() %>% arrow::write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined/rhs_long_percap.parquet") #add the parquet to the pile 

rhs_combined <- spark_read_parquet(sc,name='rhs_combined', path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined/" ,memory=F) 


rhs_codebook <- rhs_combined %>% 
                 dplyr::select(variable, variable_short, description, variable_short_group, dataset) %>% 
                 sdf_distinct() %>% #don't do regular distinct or it'll take crazy long
                 collect() %>%
                 mutate(description = description %>% str_replace_all("_", " ") %>% str_replace_all("  ", " ") %>% trimws()) %>%
                 mutate(variable_clean = variable %>% janitor::make_clean_names()) %>%  #have to do on the R side
                 mutate(variable_clean_dupe=duplicated(variable_clean)) #takes a while
rhs_codebook_spark <- sdf_copy_to(sc,x=rhs_codebook,'rhs_codebook_spark',memory=T, overwrite = TRUE)

rhs_codebook_spark  %>% spark_write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_codebook_spark/", mode="overwrite")


rhs_combined_long_dupes_48029 <- rhs_combined  %>% dplyr::select(fips, variable) %>% filter(fips==48029) %>%  collect()   %>% mutate(dupe=duplicated(paste0(fips,variable) ))

rhs_combined <- spark_read_parquet(sc,name='rhs_combined', path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined/" ,memory=F) 
rhs_codebook_spark <- spark_read_parquet(sc,name='rhs_codebook_spark', path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_codebook_spark/" ,memory=F) 

rhs_combined_long <- rhs_combined %>% dplyr::select(fips, variable,value)  %>%
                      inner_join(rhs_codebook_spark %>% filter(!variable_clean_dupe) %>% dplyr::select(variable, variable_clean)) %>% #inner join restricts it to just things in the codebook
                      dplyr::select(-variable) %>% #
                      mutate(fips=as.numeric(fips)) %>%
                      filter(!is.na(fips))  %>% 
                      dplyr::select(fips,variable_clean,value) 
                       #there are broken fips, track them down later
rhs_combined_long  %>% spark_write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined_long/", mode="overwrite")

#Because spark choked on the long to wide, we pull it into R and do it there, bonus we easily saves as a single parquet

rhs_combined_long <- spark_read_parquet(sc,name='rhs_combined_long', path="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined_long/" ,memory=F) 
rhs_combined_wide_temp_dupes <- rhs_combined_long %>% mutate(fips_variable=paste0(fips,"_", variable_clean)) %>% dplyr::select(fips_variable) %>% count(fips_variable) %>% filter(n>1) %>% collect()
dim(rhs_combined_wide_temp_dupes) #should be zero
testit::assert(nrow(rhs_combined_wide_temp_dupes)==0)

rhs_combined_long <- arrow::open_dataset(sources="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_combined_long/")
dim(rhs_combined_long)  

#I don't know why but this is taking too long.   
rhs_combined_wide_temp <- rhs_combined_long %>%
                      dplyr::select(fips,variable_clean,value) %>%
                      collect() 
dim(rhs_combined_wide_temp)

#rhs_combined_wide_temp %>% filter(fips==1115) %>% View()


rhs_combined_wide <- rhs_combined_wide_temp %>%
                      pivot_wider(names_from=variable_clean, values_from=value) 
                      #sdf_pivot(fips ~ variable_clean, #for whatever reason it is really bad at going long to wide
                      #  fun.aggregate = list(value = "mean")
                      #)
dim(rhs_combined_wide) #5093 35,583 #sticking with only or nearly only percentages reduces the cols to 35k
rhs_combined_wide_variables <- data.frame(colnames(rhs_combined_wide))

rhs_combined_wide   %>% arrow::write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_wide/rhs_combined_wide.parquet") #add the parquet to the pile 

#rhs_combined_wide  %>% spark_write_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_wide/rhs_combined_wide/", mode="overwrite")


```

# Combine LHS and RHS

```{r}

lhs <- arrow::read_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/lhs/lhs.parquet")
rhs_combined_wide <- arrow::read_parquet("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_wide/rhs_combined_wide.parquet")

rhs_combined_wide_variables <- data.frame(variables=colnames(rhs_combined_wide))

states_sf_tigris_continental <- readRDS( glue::glue("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/states_sf_tigris_continental.Rds"))
folds_df <- states_sf_tigris_continental %>% as.data.frame() %>% dplyr::select(fips_state=STATEFP, fold=fold_6) %>% mutate(fips_state=as.numeric(fips_state))

y_all <- lhs  %>% left_join(folds_df) %>% dplyr::select(fold,  fips, y=people_partial_mean, y_share14plus=people_partial_mean_perc14plus, y_share18plus=people_partial_mean_perc18plus)%>% filter(!is.na(fold))
x_all <- rhs_combined_wide %>% janitor::remove_constant() %>% clean_names() 
dim(x_all) #4600 152511
#This now takes a surprisingly long time
yx_all <- y_all %>%  mutate(fips=fips %>% as.numeric( ))  %>% filter(is.finite(y_share14plus)) %>%
          left_join(x_all %>% mutate(fips=fips %>% as.numeric() ) ) %>% janitor::remove_constant() %>% clean_names() #This cuts it down to just things that have obs in y
dim(yx_all) # 3102 145706

#colnames(x_all) %>% as.data.frame() %>% View()

yid_train <- yx_all  %>% dplyr::select(y, y_share14plus,y_share18plus, fips, fold)
saveRDS(yid_train, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/yid_train.Rds")

x_train <- yx_all %>% dplyr::select(-y, -y_share14plus, -y_share18plus, -fips, -fold) %>% Rfast::data.frame.to_matrix(col.names=T)
x_train[!is.finite(x_train)] <- NA #remove nans and infinits can do as a df but sloow
dim(x_train) #  3102 145,702

#temp <- colSums(is.na(x_train))
#missingness_df <- data.frame(missingness=colMeans(is.na(x_train)), var=colnames(x_train)) 
#summary(missingness_df$missingness)
#table(missingness_df$missingness>0.5) #26627
#table(missingness_df$missingness>0.75) #16936
#table(missingness_df$missingness>0.9) #9604
#table(missingness_df$missingness>0.95) #4653

#condition <- temp<500
#we're going to exclude anything with a lot of missingness

#table(missingness_df$missingness>0) #4817 have som missingess
#x_train <- x_train[,colMeans(is.na(x_train))<0.9] #less than 90%  missing
#dim(x_train) #3106 65149
#missingness_df <- data.frame(missingness=colMeans(is.na(x_train)), var=colnames(x_train)) 
#summary(missingness_df$missingness)
#x_train <-scale(x_train)
saveRDS(x_train, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/x_train.Rds")

remaining_folds1 <- yx_all$fold %>% unique()
Folds1 <- list(
    Fold1 = which(yx_all$fold==remaining_folds1[1]) #There are 5 folds left to choose from, here we fit on everything but the first one
  , Fold2 = which(yx_all$fold==remaining_folds1[2]) #Everything but the second one
  , Fold3 = which(yx_all$fold==remaining_folds1[3])
  , Fold4 = which(yx_all$fold==remaining_folds1[4])
  , Fold5 = which(yx_all$fold==remaining_folds1[5])
  , Fold6 = which(yx_all$fold==remaining_folds1[6])
)
      
saveRDS(Folds1, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/Folds1.Rds")

```




# Impute Combine into Final Dataset

Create and save an imputed dataset

```{r, eval=F}

x_train <- readRDS( "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/x_train.Rds")
dim(x_train)
missingness_df <- data.frame(missingness=colMeans(is.na(x_train)), var=colnames(x_train)) 
summary(missingness_df$missingness)
table(missingness_df$missingness>0) #4k have some missingness

x_train_df <- x_train %>% as.data.frame()
library(randomForestSRC)
x_train_imputed <- impute.rfsrc(data = x_train_df,
                                nodesize = 1, nsplit = 10, nimpute = 1,
                                fast = T,
                                ntree =100
                                ) #it has a long single core leadup but then goes multicore

missingness_df_imputed <- data.frame(missingness=colMeans(is.na(x_train_imputed)), var=colnames(x_train_imputed)) 
summary(missingness_df_imputed$missingness)

# #install.packages("devtools")
# #devtools::install_github(repo = "amices/mice")
# library(mice)
# imp <- mice(x_train, m=1)
# x_train_imputed <- complete(imp)
# 
# library(doParallel)
# cl <- makeCluster(64)
# registerDoParallel(cl)
# p_load(miceRanger)
# library(tictoc)
# tic()
#   miceObjPar <- miceRanger(
#      data=x_train %>% as.data.table() 
#     , m=1
#     , parallel = TRUE
#     , verbose = T
#   )
# toc() #206 seconds for 1k. 140 minutes if it's linear time in everything else
# 
# stopCluster(cl)
# registerDoSEQ()
# 
# imputedList <- completeData(miceObjPar)

#x_train_imputed <- imputedList[[1]]
saveRDS(x_train_imputed, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs/x_train_imputed.Rds")

```

# Cluster Variables symantically here

```{r}

rhs_codebook <- arrow::open_dataset(sources="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_codebook_spark/") %>% collect()

rhs_codebook <- rhs_codebook %>% 
                mutate(description_stemmed= description %>% str_replace("per capita|percapita|per 1000|percent$|perc$|perc 1,000|^percent|^perc","") %>% tolower() %>% trimws() %>% str_replace("  "," ") %>% tolower()  )  %>%
                mutate(description_sentence= paste0("This variable measures ",description_stemmed  ,".") )

x_all <- readRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/x_train.Rds")


setdiff(rhs_codebook$variable_clean, colnames(x_all)) %>% length()
setdiff( colnames(x_all), rhs_codebook$variable_clean) %>% length() #ok this is zero, so all of x appears in the variable clean column

rhs_codebook_total <- rhs_codebook %>% filter(variable_clean %in% colnames(x_all) ) #subset the codebook to just what we're using

head(rhs_codebook$description)
head(rhs_codebook$description_sentence)

description_sentence_unique <- rhs_codebook_total$description_sentence %>% unique 
description_sentence_unique %>% length() #29076

```



```{python}


#pip install -U sentence-transformers
#pip install bertopic
#pip install bertopic[all]

from sentence_transformers import SentenceTransformer
#https://huggingface.co/sentence-transformers/paraphrase-multilingual-mpnet-base-v2 #says you have to use the sentence transformers front end
model = SentenceTransformer('sentence-transformers/paraphrase-multilingual-mpnet-base-v2' ) #"paraphrase-mpnet-base-v2" 'paraphrase-MiniLM-L6-v2' #this is downloading crazy slow 400mb but hours to download

#Our sentences we like to encode
sentences = ['This framework generates embeddings for each input sentence',
    'Sentences are passed as a list of string.', 
    'The quick brown fox jumps over the lazy dog.']

#Sentences are encoded by calling model.encode()
sentence_embeddings = model.encode(r.description_sentence_unique)
sentence_embeddings.shape

#If it gets bigger you can switch to faiss and kmeans but wanted to stick with hclust for as long as I could
#https://github.com/facebookresearch/faiss/wiki/Faiss-building-blocks:-clustering,-PCA,-quantization
#import faiss
#ncentroids = 1024
#niter = 20
#verbose = True
#d = sentence_embeddings.shape[1]
#kmeans = faiss.Kmeans(d, ncentroids, niter=niter, verbose=verbose)
#kmeans.train(sentence_embeddings)
#D, I = kmeans.index.search(sentence_embeddings, 1)

#Print the embeddings
#for sentence, embedding in zip(sentences, sentence_embeddings):
#    print("Sentence:", sentence)
#    print("Embedding:", embedding)
#    print("")
  
#https://github.com/MaartenGr/BERTopic
#from bertopic import BERTopic
#from sentence_transformers import SentenceTransformer
#sentence_model = SentenceTransformer("paraphrase-MiniLM-L6-v2") #using the best sbert embedding
#topic_model = BERTopic(embedding_model=sentence_model)
#topics, _ = topic_model.fit_transform(r.var_descriptions)
#topic_model.get_topic_info()
#topic_model.get_topic(0)
#topic_model.get_topic(1)

    
```


```{r}

#install.packages("fastcluster")
library(fastcluster)
library(reticulate)
py$sentence_embeddings %>% dim()
m <- py$sentence_embeddings
rownames(m) <- description_sentence_unique
dim(m)

#library(devtools)
#install_github("alexeckert/parallelDist")
#30k is very fast 150k was rough and suggest switching to faiss 
d <- m %>%   parallelDist::parDist(threads = 64, method="cosine") #I need to use cosine distance I think this is similarity so I need to do 1-
hc <- d %>% fastcluster::hclust(method="ward.D2") #yup it's just the dist that's slow. Have to 
  #ape::as.phylo() %>% 
  #plot()
#hc <- fastcluster::hclust.vector(m, method="ward")
  
#d <- dist(m)
#hc <- hclust(d, method="ward.D2")
library(ggdendro)
#p_ggdendrogram <- hc %>% ggdendrogram( rotate = T, size = 2) #This is painfully slow, i might have to do do this as a dataframe with cuts instead
#ggsave(filename="/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/docs/plots/p_ggdendrogram.pdf", width = 20, height = 1000, limitsize = FALSE) #only opens in chrome

#my_cut_function <- function(x, number){
#  #we throw away X
#  return(list(cluster=hc %>% cutree(2) ))
#}
#fviz_nbclust(m, my_cut_function, method = "wss", diss=d, nboot=10, print.summary	=T) #+ geom_vline(xintercept = 3, linetype = 2) #real slow

#I'm going to end up doing this damn thing by hand
#clusters <-  hc %>% cutree(2)
#d_m <- as.matrix(d)
#dim(d_m)
#d_1 <- d_m[clusters==1, clusters==1]
#d_1_off <- d_m[clusters==1, clusters!=1]
#d_2 <- d_m[clusters==2, clusters==2]


get_intervsouter_distance <- function(cuts){
  print(cuts)
  clusters <-  hc %>% cutree(cuts)
  cluster_means <- lapply(clusters %>% unique(), function(x) m[clusters==x,] %>% colMeans()   )  %>% do.call(rbind, .)
  m_centroids <- cluster_means[clusters,]
  differences <- (m-m_centroids)^2
  differences_sum <- sum(differences)
  return(differences_sum)
}

within_sum_squares <- sapply(1:200, get_intervsouter_distance)
plot(within_sum_squares/within_sum_squares[1])
plot(diff(within_sum_squares))
df <- data.frame(x=1:length(diff(within_sum_squares)),y=diff(within_sum_squares)*-1)
lm1 <- lm(y~1+x+I(x^2),data= df)
loess1 <- stats::loess(y~x, data=df, span=0.05)
df$yhat <- loess1$fitted
df$resid <- df$y/df$yhat
df$resid_125 <- df$resid>1.25 | df$yhat>2000
ggplot(df, aes(x=x)) + geom_point(aes(y=y, color=resid_125)) + geom_line(aes(y=yhat), color="blue") #geom_smooth(aes(y=y), span = 0.2)
sum(df$resid_125)

#install.packages('elbow')
#install.packages("remotes")
#remotes::install_github("ahasverus/elbow")
library(elbow)
optimal_clusters <- elbow(data.frame(1:length(within_sum_squares), within_sum_squares/within_sum_squares[1]), plot = TRUE)$X1.length.within_sum_squares._selected
print(optimal_clusters)
#install.packages('clustree')
#library(clustree)

#install.packages('cValid')
#library(cValid)


get_DV_ON_RHS <- function(cuts){
  print(cuts)
  dontsplit <- description_sentence_unique[description_sentence_unique %>% str_detect("DV_ON_RHS")]
  clusters <-  hc %>% cutree(cuts)
  number_split <- clusters[dontsplit]
  grouped_with <- sum(clusters %in% number_split)-length(dontsplit)
  return(grouped_with)
}
within_DV_ON_RHS <- sapply(1:200, get_DV_ON_RHS)
plot(within_DV_ON_RHS)
which(within_DV_ON_RHS==0) %>% min() #what is the minimum where politics is split off on its own? 96 99


get_politics <- function(cuts){
  print(cuts)
  dontsplit <- description_sentence_unique[description_sentence_unique %>% str_detect("politics")]
  clusters <-  hc %>% cutree(cuts)
  number_split <- clusters[dontsplit]
  grouped_with <- sum(clusters %in% number_split)-length(dontsplit)
  return(grouped_with)
}
within_getpolitics <- sapply(1:200, get_politics)
plot(within_getpolitics)
which(within_getpolitics==0) %>% min() #what is the minimum where politics is split off on its own? 96 99

get_masks <- function(cuts){
  print(cuts)
  dontsplit <- description_sentence_unique[description_sentence_unique %>% str_detect("mask")]
  clusters <-  hc %>% cutree(cuts)
  number_split <- clusters[dontsplit]
  grouped_with <- sum(clusters %in% number_split)-length(dontsplit)
  return(grouped_with)
}
within_get_masks <- sapply(1:200, get_masks)
plot(within_get_masks)
which(within_get_masks==0) %>% min() #what is the minimum where politics is split off on its own? 96 99

smallest_cluster <- max(
  which(within_getpolitics==0) %>% min(),
  which(within_get_masks==0) %>% min(),
  which(within_DV_ON_RHS==0) %>% min()
)

#https://github.com/jlmelville/uwot
library(stringr)
df_clustered <- data.frame(description_sentence = description_sentence_unique)
dim(df_clustered)
cluster_cuts <- which(df$resid_125==T)+1
cluster_cuts <- cluster_cuts[cluster_cuts<smallest_cluster]
cluster_cuts <- c(cluster_cuts,smallest_cluster) %>% unique()
for(i in cluster_cuts ) {
  print(i)
  varname <- paste0("k",str_pad(i, 3, pad = "0"))
  df_clustered[,varname] <- paste0("k",i,"_", hc %>% cutree(i)) #%>% str_pad(3, pad = "0")
}
df_clustered

#The problem is that cuttree keeps cutting whether it needs to be or not. So you want to pull up a level if all the descendants share that seem lead


write.csv(df_clustered, "/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/docs/plots/df_clustered.csv")

p_load(data.tree)
df_clustered$pathString <- apply(df_clustered[,-1], 1, paste, collapse="/")

population <- as.Node(df_clustered %>% dplyr::select(description_sentence, pathString)) #This takes a long time, it does finish but takes a while
print(population, "description_sentence", limit = 20)
print(population, "description_sentence", limit = 100)

library(igraph)
g <- as.igraph(population, directed=TRUE)

for(i in 1:50){
  for(v in V(g)) {
    print(v)
    try({
      children <- neighbors(g, v, mode = c("out"))
      parents <- neighbors(g, v, mode = c("in"))
      if(length(parents)==1 & length(children)==1){
        print("deleting")
        g <<- g %>% add_edges(c(which(V(g)$name == parents[1]$name) , which(V(g)$name == children[1]$name) ))
        g <<- delete_vertices(g, v)
      }
    })
  }
}

V(g) #277 vertices It would take 7 days to fit all of them

#devtools::install_github("USCbiostats/aphylo")
library(aphylo)
g_df <- g %>% as_data_frame() 
levs <- unique(c(g_df$from, g_df$to)) %>% sort()
g_df$from <- factor(g_df$from, levels= levs ) %>% as.numeric()
g_df$to <- factor(g_df$to, levels= levs )  %>% as.numeric()

g_phylo <- g_df %>% as.matrix() %>% as.phylo() 
p_load(phylogram)
g_dendro <- g_phylo %>% phylogram::as.dendrogram()

library(networkD3)
radialNetwork(as.radialNetwork(g_dendro))


#ok so how are we going to label these clusters?
#I tried to use fancy language models to do it automagically but they failed me
#I think instead I'll just treat this as

library(pacman)
p_load(tokenizers)
p_load(stopwords)
p_load(quanteda)

require(quanteda)
require(quanteda.textstats)
corp_immig <- corpus(df_clustered$description_sentence %>% str_replace_all("_", " "))
toks_inaug <- tokens(corp_immig, remove_punct = TRUE, remove_symbols=T, remove_numbers=T, remove_separators=T, split_hyphens=T)
grams <- tokens_ngrams(toks_inaug, 1:3)
dfmat_inaug <- dfm(grams)
print(dfmat_inaug)
dim(dfmat_inaug)

dfmat_inaug_df <- as.data.frame(dfmat_inaug)
dim(dfmat_inaug_df)



```

```{python}

from transformers import pipeline
summarizer = pipeline("summarization")
ARTICLE = """ New York (CNN)When Liana Barrientos was 23 years old, she got married in Westchester County, New York.
 A year later, she got married again in Westchester County, but to a different man and without divorcing her first husband.
 Only 18 days after that marriage, she got hitched yet again. Then, Barrientos declared "I do" five more times, sometimes only within two weeks of each other.
 In 2010, she married once more, this time in the Bronx. In an application for a marriage license, she stated it was her "first and only" marriage.
 Barrientos, now 39, is facing two criminal counts of "offering a false instrument for filing in the first degree," referring to her false statements on the
 2010 marriage license application, according to court documents.
 Prosecutors said the marriages were part of an immigration scam.
 On Friday, she pleaded not guilty at State Supreme Court in the Bronx, according to her attorney, Christopher Wright, who declined to comment further.
 After leaving court, Barrientos was arrested and charged with theft of service and criminal trespass for allegedly sneaking into the New York subway through an emergency exit, said Detective
 Annette Markowski, a police spokeswoman. In total, Barrientos has been married 10 times, with nine of her marriages occurring between 1999 and 2002.
 All occurred either in Westchester County, Long Island, New Jersey or the Bronx. She is believed to still be married to four men, and at one time, she was married to eight men at once, prosecutors say.
 Prosecutors said the immigration scam involved some of her husbands, who filed for permanent residence status shortly after the marriages.
 Any divorces happened only after such filings were approved. It was unclear whether any of the men will be prosecuted.
 The case was referred to the Bronx District Attorney\'s Office by Immigration and Customs Enforcement and the Department of Homeland Security\'s
 Investigation Division. Seven of the men are from so-called "red-flagged" countries, including Egypt, Turkey, Georgia, Pakistan and Mali.
 Her eighth husband, Rashid Rajput, was deported in 2006 to his native Pakistan after an investigation by the Joint Terrorism Task Force.
 If convicted, Barrientos faces up to four years in prison.  Her next court appearance is scheduled for May 18.
"""


from transformers import AutoModelForSeq2SeqLM, AutoTokenizer
model = AutoModelForSeq2SeqLM.from_pretrained("t5-base")
tokenizer = AutoTokenizer.from_pretrained("t5-base")

# T5 uses a max_length of 512 so we cut the article to 512 tokens.
inputs = tokenizer.encode("summarize: " + ARTICLE, return_tensors="pt", max_length=512, truncation=True)
outputs = model.generate(inputs, max_length=150, min_length=40, length_penalty=2.0, num_beams=4, early_stopping=True)
print(tokenizer.decode(outputs[0], skip_special_tokens=True))


#Hello! GPT Neo is available on the master branch, while you're installing the version v4.2.2.
#You should change pip install transformers to pip install git+https://github.com/huggingface/transformers and reload your kernel
from transformers import pipeline
generator = pipeline('text-generation', model='EleutherAI/gpt-neo-2.7B')
generator("EleutherAI has", do_sample=True, min_length=50, temperature=0.3, max_length=100)

prompt="""
Generate a tweet from a key word:
  
key: markets
tweet: Take feedback from nature and markets, not from people

key: children
tweet: Maybe we die so we can come back as children.

key:startups
tweet: Startups shouldn't worry about how to put out fires, they should worry about how to start them.

key:hugging face
tweet:
"""

result= generator(prompt, do_sample=True, min_length=len(prompt)+10, temperature=0.3, max_length=len(prompt)+100)


#https://www.deepspeed.ai/tutorials/inference-tutorial/
#https://huggingface.co/transformers/main_classes/deepspeed.html
import os
import deepspeed
import torch
import transformers
from transformers import pipeline

local_rank = int(os.getenv('LOCAL_RANK', '0'))
world_size = int(os.getenv('WORLD_SIZE', '1'))
generator = pipeline('text-generation', model='EleutherAI/gpt-neo-1.3B', device=local_rank)

generator.model = deepspeed.init_inference(generator.model,
                                           mp_size=world_size,
                                           dtype=torch.float,
                                           replace_method='auto')

string = generator("DeepSpeed is", do_sample=True, min_length=50)

if torch.distributed.get_rank() == 0:
    print(string)

prompt = """Translate English to French:
  
sea otter => loutre de mer
peppermint => menthe poivre
plush giraffe => peluche girafe
good evening => bon soir
thank you => merci
cheese =>"""

string = generator(prompt, do_sample=True, max_new_tokens=50, temperature=0.5, max_length=100)
string


```

```{r}
table(df_clustered$k_smallest)

#I think we now break descriptions into words and predict which of each clustering by word, and that becomes the cluster summary


#install.packages('dynamicTreeCut')
#library(dynamicTreeCut)
#?dynamicTreeCut

#install.packages("uwot")
library(uwot)
m_umap <- umap(m, n_neighbors = 15, min_dist = 0.001, verbose = TRUE, n_threads = 64) #, pca = 50
plot(m_umap)
df_clustered$x <- m_umap[,1]
df_clustered$y <- m_umap[,2]

df_clustered %>% ggplot(aes(x,y, col=k_smallest %>% as.factor())) + geom_point() + theme(legend.position = "none") #

rhs_codebook_total_clustered <- rhs_codebook_total %>% 
  left_join(df_clustered) %>% mutate(variable_clean_255 = abbreviate(variable_clean, 255, strict=T)  ) %>%
  mutate(variable_clean_255_dupe = duplicated(variable_clean_255)) %>%
  mutate(variable_clean_255 = ifelse(variable_clean_255_dupe, variable_clean %>% abbreviate(200, strict=T) %>% paste0(row_number()) , variable_clean_255 )     )  #for the 500 or so var names that couldn't be uniquely shortened we just add a number 
  
table(nchar(rhs_codebook_total_clustered$variable_clean_255)) #wow it was unable to abbreviate

table(table(rhs_codebook_total_clustered$variable_clean_255)) #543 got duplicated, reall we don't care since we're keeping track of everything with the codebook

d <- NULL
m <- NULL
gc()


rhs_codebook_total_clustered %>% saveRDS("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/data_out/rhs_codebook_total_clustered.Rds")


rhs_codebook_total_clustered <- rhs_codebook_total_clustered %>% arrange(k2,k3,k4,k5,k6,k7,k8,k9,k10,k20, k20, k40, k60, k80,k90,k_smallest) 

```


```{python, eval=F}

from transformers import pipeline
summarizer = pipeline("summarization")
ARTICLE = """ New York (CNN)When Liana Barrientos was 23 years old, she got married in Westchester County, New York.
... A year later, she got married again in Westchester County, but to a different man and without divorcing her first husband.
... Only 18 days after that marriage, she got hitched yet again. Then, Barrientos declared "I do" five more times, sometimes only within two weeks of each other.
... In 2010, she married once more, this time in the Bronx. In an application for a marriage license, she stated it was her "first and only" marriage.
... Barrientos, now 39, is facing two criminal counts of "offering a false instrument for filing in the first degree," referring to her false statements on the
... 2010 marriage license application, according to court documents.
... Prosecutors said the marriages were part of an immigration scam.
... On Friday, she pleaded not guilty at State Supreme Court in the Bronx, according to her attorney, Christopher Wright, who declined to comment further.
... After leaving court, Barrientos was arrested and charged with theft of service and criminal trespass for allegedly sneaking into the New York subway through an emergency exit, said Detective
... Annette Markowski, a police spokeswoman. In total, Barrientos has been married 10 times, with nine of her marriages occurring between 1999 and 2002.
... All occurred either in Westchester County, Long Island, New Jersey or the Bronx. She is believed to still be married to four men, and at one time, she was married to eight men at once, prosecutors say.
... Prosecutors said the immigration scam involved some of her husbands, who filed for permanent residence status shortly after the marriages.
... Any divorces happened only after such filings were approved. It was unclear whether any of the men will be prosecuted.
... The case was referred to the Bronx District Attorney\'s Office by Immigration and Customs Enforcement and the Department of Homeland Security\'s
... Investigation Division. Seven of the men are from so-called "red-flagged" countries, including Egypt, Turkey, Georgia, Pakistan and Mali.
... Her eighth husband, Rashid Rajput, was deported in 2006 to his native Pakistan after an investigation by the Joint Terrorism Task Force.
... If convicted, Barrientos faces up to four years in prison.  Her next court appearance is scheduled for May 18.
... """

print(summarizer(ARTICLE, max_length=130, min_length=30, do_sample=False))

import pandas as pd
py_df_clustered = pd.read_csv("/mnt/8tb_a/rwd_github_private/TrumpSupportVaccinationRates/docs/plots/df_clustered.csv")

cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==127, "description"]
article='\n '.join(cluster_descriptions.array[1:50]) #the most it can do is 50 lines
print(summarizer(article, max_length=50, min_length=10, do_sample=False))

summarizer = pipeline("summarization", model="bart-large-cnn", tokenizer="bart-large-cnn", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=10)


cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==127, "description"]
article='\n '.join(cluster_descriptions.array[1:50]) #the most it can do is 50 lines
summarizer = pipeline("summarization", model="google/pegasus-xsum", tokenizer="google/pegasus-xsum", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=10)


cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==1, "description"]
article='\n '.join(cluster_descriptions.array[1:25]) #the most it can do is 50 lines
summarizer = pipeline("summarization", model="google/pegasus-xsum", tokenizer="google/pegasus-xsum", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=20)


cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==2, "description"]
article='\n '.join(cluster_descriptions.array[1:25]) #the most it can do is 50 lines
summarizer = pipeline("summarization", model="google/pegasus-xsum", tokenizer="google/pegasus-xsum", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=20)


cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==3, "description"]
article='\n '.join(cluster_descriptions.array[1:25]) #the most it can do is 50 lines
summarizer = pipeline("summarization", model="google/pegasus-xsum", tokenizer="google/pegasus-xsum", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=20)

cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==4, "description"]
article='\n '.join(cluster_descriptions.array[1:25]) #the most it can do is 50 lines
summarizer = pipeline("summarization", model="google/pegasus-xsum", tokenizer="google/pegasus-xsum", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=20)

cluster_descriptions = py_df_clustered.loc[py_df_clustered["k127"]  ==5, "description"]
article='\n '.join(cluster_descriptions.array[1:25]) #the most it can do is 50 lines
#Confirmed T5 11b fails on my gpu
summarizer = pipeline("summarization", model="t5-base", tokenizer="t5-base", framework="tf") #in tf it uses gpu automatically, the t5-11b is 45gb and probably won't run on my gpu. Downloading anyway for fun
summarizer(article, min_length=5, max_length=20)


```




